<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyrotechnik Lager Manager Pro - GitHub Ready</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .scanner-line {
            animation: scan 2s linear infinite;
        }
        @keyframes scan {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(300px); }
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success { background-color: #10b981; }
        .notification.error { background-color: #ef4444; }
        .notification.info { background-color: #3b82f6; }
        .image-preview {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 8px;
        }
        .github-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .github-connected {
            background-color: #dcfce7;
            color: #166534;
        }
        .github-disconnected {
            background-color: #fef2f2;
            color: #dc2626;
        }
        @media (max-width: 768px) {
            .notification {
                right: 10px;
                left: 10px;
                transform: translateY(-100px);
            }
            .notification.show {
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
    <!-- Notification Container -->
    <div id="notification-container"></div>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">üéÜ Pyrotechnik Lager Manager Pro</h1>
                    <p class="text-gray-600">Multi-Ger√§t Inventarverwaltung mit GitHub-Synchronisation</p>
                    <div class="mt-2 flex items-center gap-3">
                        <div class="text-sm text-green-600 bg-green-50 px-3 py-1 rounded-full">
                            ‚úÖ GitHub Pages Ready
                        </div>
                        <div id="github-status" class="github-status github-disconnected">
                            ‚ùå GitHub nicht konfiguriert
                        </div>
                    </div>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <div class="flex items-center gap-2">
                        <span id="sync-status" class="text-sm text-gray-500">üîÑ Bereit</span>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="showGitHubConfig()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm transition-colors">
                            ‚öôÔ∏è GitHub Setup
                        </button>
                        <button onclick="exportToCloud()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm transition-colors">
                            ‚òÅÔ∏è Hochladen
                        </button>
                        <button onclick="importFromCloud()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm transition-colors">
                            üì• Herunterladen
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="bg-white rounded-lg shadow-lg mb-8">
            <div class="flex flex-wrap border-b overflow-x-auto">
                <button onclick="showTab('scanner')" id="tab-scanner" class="px-6 py-4 font-medium text-blue-600 border-b-2 border-blue-600 whitespace-nowrap">
                    üì± Scanner
                </button>
                <button onclick="showTab('inventory')" id="tab-inventory" class="px-6 py-4 font-medium text-gray-500 hover:text-blue-600 whitespace-nowrap">
                    üìã Inventar
                </button>
                <button onclick="showTab('add-item')" id="tab-add-item" class="px-6 py-4 font-medium text-gray-500 hover:text-blue-600 whitespace-nowrap">
                    ‚ûï Artikel hinzuf√ºgen
                </button>
                <button onclick="showTab('reports')" id="tab-reports" class="px-6 py-4 font-medium text-gray-500 hover:text-blue-600 whitespace-nowrap">
                    üìä Berichte
                </button>
            </div>
        </div>

        <!-- Scanner Tab -->
        <div id="scanner-tab" class="tab-content">
            <div class="grid lg:grid-cols-2 gap-8">
                <!-- Scanner Interface -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üîç Barcode Scanner</h2>
                    
                    <!-- Live Camera Scanner -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">üìπ Live Kamera Scanner</h3>
                        <div class="relative bg-gray-900 rounded-lg p-4 mb-4" style="height: 300px;">
                            <video id="camera-video" class="w-full h-full object-cover rounded hidden" autoplay playsinline muted></video>
                            <div id="scanner-placeholder" class="absolute inset-4 border-2 border-green-400 rounded-lg">
                                <div class="scanner-line absolute w-full h-1 bg-green-400 opacity-70"></div>
                                <div class="absolute bottom-4 left-4 right-4 text-center">
                                    <p class="text-green-400 text-sm">Kamera starten um Barcodes zu scannen</p>
                                </div>
                            </div>
                            <div id="scan-overlay" class="absolute inset-4 border-2 border-green-400 rounded-lg hidden">
                                <div class="scanner-line absolute w-full h-1 bg-green-400 opacity-70"></div>
                                <div class="absolute bottom-4 left-4 right-4 text-center">
                                    <p class="text-green-400 text-sm">Barcode in den Rahmen halten</p>
                                </div>
                            </div>
                        </div>
                        <button onclick="toggleCamera()" id="camera-toggle" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 mb-4 transition-colors">
                            üì∑ Kamera starten
                        </button>
                    </div>

                    <!-- Manual Input -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">‚å®Ô∏è Manuelle Eingabe</h3>
                        <input type="text" id="barcode-input" placeholder="Barcode hier eingeben..." 
                               class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <button onclick="scanBarcode()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors">
                            üîç Suchen
                        </button>
                    </div>
                </div>

                <!-- Scan Results -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üìÑ Scan Ergebnis</h2>
                    <div id="scan-result" class="text-center text-gray-500 py-8">
                        Scannen Sie einen Barcode um Details anzuzeigen
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-xl font-bold text-gray-800">üì¶ Inventar √úbersicht</h2>
                    <div class="flex flex-col sm:flex-row gap-4 w-full md:w-auto">
                        <input type="text" id="search-inventory" placeholder="Artikel suchen..." 
                               class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 flex-1 md:flex-none">
                        <input type="file" id="excel-upload" accept=".xlsx,.xls,.csv" style="display: none;" onchange="importExcel(event)">
                        <button onclick="document.getElementById('excel-upload').click()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                            üì§ Excel Import
                        </button>
                        <button onclick="exportInventory()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            üì• Export CSV
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Artikel</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Barcode</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Bestand</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Preis</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table" class="divide-y divide-gray-200">
                            <!-- Inventory items will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Add Item Tab -->
        <div id="add-item-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">‚ûï Neuen Artikel hinzuf√ºgen</h2>
                <form id="add-item-form" class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Artikelname *</label>
                        <input type="text" id="item-name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Barcode *</label>
                        <input type="text" id="item-barcode" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Anzahl *</label>
                        <input type="number" id="item-quantity" required min="0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Preis (‚Ç¨) *</label>
                        <input type="number" id="item-price" required min="0" step="0.01" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kategorie</label>
                        <select id="item-category" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="Raketen">üöÄ Raketen</option>
                            <option value="Batterien">üîã Batterien</option>
                            <option value="R√∂mische Lichter">üí° R√∂mische Lichter</option>
                            <option value="Font√§nen">‚õ≤ Font√§nen</option>
                            <option value="Bengalos">üî• Bengalos</option>
                            <option value="Knaller">üí• Knaller</option>
                            <option value="Verbundfeuerwerk">üéÜ Verbundfeuerwerk</option>
                            <option value="Sonstiges">üì¶ Sonstiges</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mindestbestand</label>
                        <input type="number" id="item-min-stock" min="0" value="5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Beschreibung</label>
                        <textarea id="item-description" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                            Artikel hinzuf√ºgen
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports-tab" class="tab-content hidden">
            <div class="grid lg:grid-cols-2 gap-8">
                <!-- Statistics -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üìä Statistiken</h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-4 bg-blue-50 rounded-lg">
                            <span class="text-gray-700">Gesamtartikel:</span>
                            <span id="total-items" class="font-bold text-blue-600">0</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-green-50 rounded-lg">
                            <span class="text-gray-700">Gesamtwert:</span>
                            <span id="total-value" class="font-bold text-green-600">‚Ç¨0.00</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-red-50 rounded-lg">
                            <span class="text-gray-700">Niedrige Best√§nde:</span>
                            <span id="low-stock-count" class="font-bold text-red-600">0</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-purple-50 rounded-lg">
                            <span class="text-gray-700">Kategorien:</span>
                            <span id="category-count" class="font-bold text-purple-600">0</span>
                        </div>
                    </div>
                </div>

                <!-- Low Stock Alert -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">‚ö†Ô∏è Niedrige Best√§nde</h2>
                    <div id="low-stock-items" class="space-y-2">
                        <p class="text-gray-500 text-center py-4">Keine Artikel mit niedrigem Bestand</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // GitHub Sync Manager
        class GitHubSyncManager {
            constructor() {
                this.token = localStorage.getItem('github_token');
                this.repo = localStorage.getItem('github_repo');
                this.branch = 'main';
                this.fileName = 'inventory.json';
                this.updateStatus();
            }
            
            configure(token, repo) {
                this.token = token;
                this.repo = repo;
                localStorage.setItem('github_token', token);
                localStorage.setItem('github_repo', repo);
                this.updateStatus();
            }
            
            updateStatus() {
                const statusEl = document.getElementById('github-status');
                if (statusEl) {
                    if (this.token && this.repo) {
                        statusEl.className = 'github-status github-connected';
                        statusEl.textContent = `‚úÖ ${this.repo}`;
                    } else {
                        statusEl.className = 'github-status github-disconnected';
                        statusEl.textContent = '‚ùå GitHub nicht konfiguriert';
                    }
                }
            }
            
            async uploadToGitHub() {
                if (!this.token || !this.repo) {
                    throw new Error('GitHub nicht konfiguriert');
                }
                
                const data = {
                    inventory: inventory,
                    lastSync: new Date().toISOString(),
                    deviceInfo: {
                        userAgent: navigator.userAgent,
                        timestamp: Date.now()
                    },
                    version: '2.1'
                };
                
                // UTF-8 sicheres Base64 Encoding
                const jsonString = JSON.stringify(data, null, 2);
                const content = btoa(unescape(encodeURIComponent(jsonString)));
                
                // Aktuelle Datei-Info abrufen
                let sha = null;
                try {
                    const response = await fetch(`https://api.github.com/repos/${this.repo}/contents/${this.fileName}`, {
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (response.ok) {
                        const fileInfo = await response.json();
                        sha = fileInfo.sha;
                    }
                } catch (error) {
                    console.log('Datei existiert noch nicht');
                }
                
                // Datei hochladen
                const uploadData = {
                    message: `Inventar Update - ${new Date().toLocaleString('de-DE')}`,
                    content: content,
                    branch: this.branch
                };
                
                if (sha) {
                    uploadData.sha = sha;
                }
                
                const uploadResponse = await fetch(`https://api.github.com/repos/${this.repo}/contents/${this.fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${this.token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(uploadData)
                });
                
                if (!uploadResponse.ok) {
                    const error = await uploadResponse.json();
                    throw new Error(`GitHub Upload Fehler: ${error.message}`);
                }
                
                return await uploadResponse.json();
            }
            
            async downloadFromGitHub() {
                if (!this.token || !this.repo) {
                    throw new Error('GitHub nicht konfiguriert');
                }
                
                const response = await fetch(`https://api.github.com/repos/${this.repo}/contents/${this.fileName}`, {
                    headers: {
                        'Authorization': `token ${this.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('Keine Backup-Datei gefunden');
                    }
                    throw new Error(`GitHub Download Fehler: ${response.status}`);
                }
                
                const fileInfo = await response.json();
                // UTF-8 sicheres Base64 Decoding
                const content = decodeURIComponent(escape(atob(fileInfo.content)));
                const data = JSON.parse(content);
                
                return data;
            }
            
            async autoSync() {
                try {
                    const remoteData = await this.downloadFromGitHub();
                    const remoteTime = new Date(remoteData.lastSync).getTime();
                    const localTime = new Date(localStorage.getItem('lastLocalUpdate') || 0).getTime();
                    
                    if (remoteTime > localTime) {
                        return await this.mergeRemoteData(remoteData);
                    } else {
                        return await this.uploadToGitHub();
                    }
                } catch (error) {
                    if (error.message.includes('nicht gefunden')) {
                        return await this.uploadToGitHub();
                    }
                    throw error;
                }
            }
            
            async mergeRemoteData(remoteData) {
                const mergeChoice = confirm(
                    `Remote-Daten gefunden (${remoteData.inventory.length} Artikel)\n` +
                    `Letzte Sync: ${new Date(remoteData.lastSync).toLocaleString('de-DE')}\n\n` +
                    `OK = Remote-Daten √ºbernehmen\n` +
                    `Abbrechen = Zusammenf√ºhren`
                );
                
                if (mergeChoice) {
                    inventory = remoteData.inventory;
                } else {
                    let mergedCount = 0;
                    remoteData.inventory.forEach(remoteItem => {
                        const localItem = inventory.find(item => item.barcode === remoteItem.barcode);
                        if (!localItem) {
                            inventory.push(remoteItem);
                            mergedCount++;
                        }
                    });
                    
                    showNotification(`${mergedCount} neue Artikel zusammengef√ºhrt`, 'success');
                }
                
                saveInventory();
                updateAllViews();
                return { action: 'downloaded', count: remoteData.inventory.length };
            }
        }

        // Global variables
        let cameraStream = null;
        let codeReader = null;
        let isScanning = false;
        const githubSync = new GitHubSyncManager();

        // Enhanced inventory loading with better error handling
        let inventory = [];
        
        function initializeInventory() {
            try {
                const savedInventory = localStorage.getItem('pyrotechnikInventory');
                
                if (savedInventory && savedInventory !== 'undefined' && savedInventory !== 'null' && savedInventory.trim() !== '') {
                    const parsed = JSON.parse(savedInventory);
                    
                    if (Array.isArray(parsed) && parsed.length >= 0) {
                        // Validiere jedes Item im Array
                        const validItems = parsed.filter(item => 
                            item && 
                            typeof item === 'object' && 
                            item.id && 
                            item.name && 
                            item.barcode &&
                            typeof item.quantity === 'number' &&
                            typeof item.price === 'number'
                        );
                        
                        if (validItems.length === parsed.length) {
                            inventory = parsed;
                            console.log(`‚úÖ ${inventory.length} Artikel aus LocalStorage geladen`);
                        } else {
                            console.warn(`‚ö†Ô∏è ${parsed.length - validItems.length} ung√ºltige Artikel entfernt`);
                            inventory = validItems;
                            saveInventory(); // Bereinigte Daten speichern
                        }
                    } else {
                        throw new Error('Inventory ist kein g√ºltiges Array');
                    }
                } else {
                    console.log('Keine gespeicherten Daten gefunden, lade Standarddaten');
                    loadDefaultData();
                }
            } catch (error) {
                console.error('Fehler beim Laden des Inventars:', error);
                loadDefaultData();
                showNotification('Standarddaten geladen (Fehler beim Laden)', 'info');
            }
        }
        
        // Inventar initialisieren
        initializeInventory();

        function loadDefaultData() {
            inventory = [
                {
                    id: 1,
                    name: "Silvester Rakete Premium",
                    barcode: "1234567890123",
                    quantity: 50,
                    price: 2.99,
                    category: "Raketen",
                    minStock: 10,
                    description: "Bunte Silvester Rakete mit Goldeffekt",
                    image: "üöÄ"
                },
                {
                    id: 2,
                    name: "Feuerwerk Batterie 20-Schuss",
                    barcode: "2345678901234",
                    quantity: 25,
                    price: 15.99,
                    category: "Batterien",
                    minStock: 5,
                    description: "20-Schuss Batterie mit bunten Effekten",
                    image: "üîã"
                },
                {
                    id: 3,
                    name: "R√∂misches Licht Deluxe",
                    barcode: "3456789012345",
                    quantity: 8,
                    price: 8.50,
                    category: "R√∂mische Lichter",
                    minStock: 15,
                    description: "Mehrfarbiges r√∂misches Licht",
                    image: "üí°"
                }
            ];
        }

        // Notification system
        function showNotification(message, type = 'info') {
            if (!message) return;
            
            const container = document.getElementById('notification-container');
            if (!container) return;
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = String(message);
            
            container.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(notification)) {
                        container.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Save function
        function saveInventory() {
            try {
                if (!Array.isArray(inventory)) {
                    throw new Error('Inventory is not an array');
                }
                
                const dataToSave = inventory.filter(item => 
                    item && typeof item === 'object' && item.id && item.name && item.barcode
                );
                
                localStorage.setItem('pyrotechnikInventory', JSON.stringify(dataToSave));
                localStorage.setItem('lastLocalUpdate', new Date().toISOString());
                updateSyncStatus('üíæ Gespeichert');
                return true;
            } catch (error) {
                console.error('Error saving inventory:', error);
                showNotification('Fehler beim Speichern der Daten', 'error');
                return false;
            }
        }

        // GitHub functions
        function showGitHubConfig() {
            const currentToken = githubSync.token ? '***' + githubSync.token.slice(-4) : '';
            const currentRepo = githubSync.repo || '';
            
            const token = prompt(`GitHub Personal Access Token eingeben:\n(Aktuell: ${currentToken})`);
            if (token === null) return; // User cancelled
            
            const repo = prompt(`Repository (username/repo-name):\n(Aktuell: ${currentRepo})`);
            if (repo === null) return; // User cancelled
            
            if (token && repo) {
                githubSync.configure(token, repo);
                showNotification('GitHub konfiguriert!', 'success');
            }
        }

        async function exportToCloud() {
            try {
                if (!githubSync.token) {
                    showGitHubConfig();
                    return;
                }
                
                showNotification('Synchronisiere mit GitHub...', 'info');
                const result = await githubSync.uploadToGitHub();
                
                updateSyncStatus('‚òÅÔ∏è Mit GitHub synchronisiert');
                showNotification('Erfolgreich zu GitHub hochgeladen!', 'success');
                
            } catch (error) {
                console.error('GitHub Upload Error:', error);
                showNotification(`GitHub Fehler: ${error.message}`, 'error');
            }
        }

        async function importFromCloud() {
            try {
                if (!githubSync.token) {
                    showGitHubConfig();
                    return;
                }
                
                showNotification('Lade von GitHub...', 'info');
                const result = await githubSync.autoSync();
                
                updateSyncStatus('üì• Von GitHub geladen');
                showNotification('Erfolgreich von GitHub geladen!', 'success');
                
            } catch (error) {
                console.error('GitHub Download Error:', error);
                showNotification(`GitHub Fehler: ${error.message}`, 'error');
            }
        }

        // Camera functions
        async function toggleCamera() {
            const video = document.getElementById('camera-video');
            const toggleBtn = document.getElementById('camera-toggle');
            const placeholder = document.getElementById('scanner-placeholder');
            const overlay = document.getElementById('scan-overlay');

            if (!video || !toggleBtn || !placeholder || !overlay) return;

            if (!isScanning) {
                try {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('Camera not supported');
                    }

                    const constraints = {
                        video: {
                            facingMode: { ideal: 'environment' },
                            width: { ideal: 640, min: 320 },
                            height: { ideal: 480, min: 240 }
                        }
                    };

                    cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    video.srcObject = cameraStream;
                    video.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                    overlay.classList.remove('hidden');
                    
                    toggleBtn.textContent = '‚èπÔ∏è Kamera stoppen';
                    toggleBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    toggleBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                    
                    isScanning = true;
                    
                    if (!codeReader && window.ZXing) {
                        codeReader = new ZXing.BrowserMultiFormatReader();
                    }
                    
                    if (codeReader) {
                        startBarcodeScanning();
                    }
                    
                    showNotification('Kamera gestartet', 'success');
                    
                } catch (error) {
                    console.error('Camera access failed:', error);
                    showNotification('Kamera-Zugriff nicht m√∂glich', 'error');
                }
            } else {
                stopCamera();
            }
        }

        function stopCamera() {
            const video = document.getElementById('camera-video');
            const toggleBtn = document.getElementById('camera-toggle');
            const placeholder = document.getElementById('scanner-placeholder');
            const overlay = document.getElementById('scan-overlay');

            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            if (codeReader) {
                try {
                    codeReader.reset();
                } catch (error) {
                    console.error('Error resetting code reader:', error);
                }
            }

            if (video) video.classList.add('hidden');
            if (placeholder) placeholder.classList.remove('hidden');
            if (overlay) overlay.classList.add('hidden');
            
            if (toggleBtn) {
                toggleBtn.textContent = 'üì∑ Kamera starten';
                toggleBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                toggleBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            }
            
            isScanning = false;
            showNotification('Kamera gestoppt', 'info');
        }

        function startBarcodeScanning() {
            if (!codeReader || !isScanning) return;
            
            const video = document.getElementById('camera-video');
            if (!video) return;
            
            try {
                let lastScanTime = 0;
                const scanCooldown = 2000; // 2 Sekunden zwischen Scans
                
                codeReader.decodeFromVideoDevice(null, video, (result, err) => {
                    if (result && result.text && isScanning) {
                        const now = Date.now();
                        if (now - lastScanTime < scanCooldown) return;
                        
                        const barcode = String(result.text).trim();
                        if (barcode.length >= 3) {
                            lastScanTime = now;
                            const barcodeInput = document.getElementById('barcode-input');
                            if (barcodeInput) {
                                barcodeInput.value = barcode;
                                scanBarcode();
                                showNotification(`üì± Barcode gescannt: ${barcode}`, 'success');
                                
                                // Kurz pausieren nach erfolgreichem Scan
                                setTimeout(() => {
                                    if (isScanning) {
                                        showNotification('Scanner bereit f√ºr n√§chsten Code', 'info');
                                    }
                                }, 1000);
                            }
                        }
                    }
                    
                    if (err && err.name !== 'NotFoundException') {
                        console.warn('Barcode scanning error:', err);
                    }
                });
            } catch (error) {
                console.error('Error starting barcode scanning:', error);
                showNotification('Fehler beim Starten des Scanners', 'error');
                stopCamera();
            }
        }

        // Barcode scanning
        function scanBarcode() {
            const barcodeInput = document.getElementById('barcode-input');
            if (!barcodeInput) return;
            
            const barcode = barcodeInput.value.trim();
            
            if (!barcode) {
                showNotification('Bitte geben Sie einen Barcode ein', 'error');
                return;
            }
            
            const item = inventory.find(item => item.barcode === barcode);
            const resultDiv = document.getElementById('scan-result');
            
            if (!resultDiv) return;
            
            if (item) {
                const quantity = item.quantity || 0;
                const minStock = item.minStock || 0;
                const stockStatus = quantity <= minStock ? 'text-red-600' : 'text-green-600';
                const stockIcon = quantity <= minStock ? '‚ö†Ô∏è' : '‚úÖ';
                
                resultDiv.innerHTML = `
                    <div class="text-left">
                        <div class="flex items-center mb-4">
                            <span class="text-4xl mr-4">${item.image || 'üì¶'}</span>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">${escapeHtml(item.name || '')}</h3>
                                <p class="text-gray-600">${escapeHtml(item.category || 'Sonstiges')}</p>
                                <p class="text-sm text-gray-500">${escapeHtml(item.description || '')}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                            <div class="bg-gray-50 p-3 rounded">
                                <span class="text-gray-600">Bestand:</span>
                                <div class="flex items-center">
                                    <span class="font-bold ${stockStatus}">${quantity}</span>
                                    <span class="ml-1">${stockIcon}</span>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded">
                                <span class="text-gray-600">Preis:</span>
                                <div class="font-bold">‚Ç¨${(item.price || 0).toFixed(2)}</div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded">
                                <span class="text-gray-600">Mindestbestand:</span>
                                <div class="font-bold">${minStock}</div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded">
                                <span class="text-gray-600">Gesamtwert:</span>
                                <div class="font-bold">‚Ç¨${(quantity * (item.price || 0)).toFixed(2)}</div>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="adjustStock(${item.id}, -1)" class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600 transition-colors">-1</button>
                            <button onclick="adjustStock(${item.id}, 1)" class="bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 transition-colors">+1</button>
                            <button onclick="adjustStock(${item.id}, -5)" class="bg-red-400 text-white px-3 py-2 rounded hover:bg-red-500 transition-colors">-5</button>
                            <button onclick="adjustStock(${item.id}, 5)" class="bg-green-400 text-white px-3 py-2 rounded hover:bg-green-500 transition-colors">+5</button>
                            <button onclick="editItem(${item.id})" class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 transition-colors">‚úèÔ∏è Bearbeiten</button>
                        </div>
                    </div>
                `;
                showNotification(`Artikel gefunden: ${item.name}`, 'success');
            } else {
                resultDiv.innerHTML = `
                    <div class="text-center text-red-600">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <p class="text-lg font-bold mb-2">Artikel nicht gefunden</p>
                        <p class="text-sm text-gray-600 mb-4 font-mono bg-gray-100 p-2 rounded">${escapeHtml(barcode)}</p>
                        <button onclick="addNewItemWithBarcode('${escapeHtml(barcode)}')" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                            ‚ûï Neuen Artikel anlegen
                        </button>
                    </div>
                `;
                showNotification(`Artikel mit Barcode ${barcode} nicht gefunden`, 'error');
            }
            
            barcodeInput.value = '';
        }

        // Stock adjustment
        function adjustStock(itemId, change) {
            try {
                const item = inventory.find(item => item.id == itemId);
                if (!item) {
                    showNotification('Artikel nicht gefunden', 'error');
                    return;
                }
                
                const oldQuantity = parseInt(item.quantity) || 0;
                const newQuantity = Math.max(0, oldQuantity + change);
                item.quantity = newQuantity;
                
                console.log(`Bestand angepasst: ${item.name} von ${oldQuantity} auf ${newQuantity}`);
                
                if (saveInventory()) {
                    // Scanner-Tab aktualisieren falls aktiv
                    const currentTab = document.querySelector('.tab-content:not(.hidden)');
                    if (currentTab && currentTab.id === 'scanner-tab') {
                        const barcodeInput = document.getElementById('barcode-input');
                        if (barcodeInput && barcodeInput.value.trim() === item.barcode) {
                            setTimeout(() => scanBarcode(), 100);
                        }
                    }
                    
                    updateAllViews();
                    
                    const action = change > 0 ? 'hinzugef√ºgt' : 'entfernt';
                    const amount = Math.abs(change);
                    showNotification(`${amount}x ${action}: ${item.name} (${newQuantity} verf√ºgbar)`, 'success');
                    
                    // Warnung bei niedrigem Bestand
                    if (newQuantity <= (item.minStock || 0) && oldQuantity > (item.minStock || 0)) {
                        setTimeout(() => {
                            showNotification(`‚ö†Ô∏è Niedriger Bestand: ${item.name} (${newQuantity}/${item.minStock || 0})`, 'error');
                        }, 1000);
                    }
                } else {
                    showNotification('Fehler beim Speichern der Bestands√§nderung', 'error');
                }
            } catch (error) {
                console.error('Error adjusting stock:', error);
                showNotification('Fehler bei der Bestandsanpassung', 'error');
            }
        }

        // Inventory table
        function updateInventoryTable() {
            const tableBody = document.getElementById('inventory-table');
            if (!tableBody) return;
            
            const searchInput = document.getElementById('search-inventory');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            
            const filteredInventory = inventory.filter(item => 
                (item.name || '').toLowerCase().includes(searchTerm) ||
                (item.barcode || '').includes(searchTerm) ||
                (item.category || '').toLowerCase().includes(searchTerm) ||
                (item.description || '').toLowerCase().includes(searchTerm)
            );
            
            if (filteredInventory.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            ${searchTerm ? 'Keine Artikel gefunden' : 'Keine Artikel im Inventar'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = filteredInventory.map(item => {
                const quantity = item.quantity || 0;
                const minStock = item.minStock || 0;
                const price = item.price || 0;
                
                const stockStatus = quantity <= minStock ? 'text-red-600' : 'text-green-600';
                const statusBadge = quantity <= minStock ? 
                    'bg-red-100 text-red-800' : 
                    quantity > minStock * 2 ? 
                        'bg-green-100 text-green-800' : 
                        'bg-yellow-100 text-yellow-800';
                const statusText = quantity <= minStock ? 'Niedrig' : 
                    quantity > minStock * 2 ? 'Gut' : 'Normal';
                
                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3">
                            <div class="flex items-center">
                                <span class="text-2xl mr-3">${item.image || 'üì¶'}</span>
                                <div>
                                    <div class="font-medium text-gray-900">${escapeHtml(item.name || '')}</div>
                                    <div class="text-sm text-gray-500">${escapeHtml(item.category || 'Sonstiges')}</div>
                                    ${item.description ? `<div class="text-xs text-gray-400 mt-1">${escapeHtml(item.description)}</div>` : ''}
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-sm font-mono bg-gray-100 px-2 py-1 rounded">${escapeHtml(item.barcode || '')}</div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex items-center">
                                <span class="font-bold ${stockStatus}">${quantity}</span>
                                <span class="text-xs text-gray-500 ml-1">/ ${minStock}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="font-medium">‚Ç¨${price.toFixed(2)}</span>
                        </td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs rounded-full ${statusBadge}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex gap-1">
                                <button onclick="adjustStock(${item.id}, -1)" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 transition-colors" title="Bestand -1">-</button>
                                <button onclick="adjustStock(${item.id}, 1)" class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600 transition-colors" title="Bestand +1">+</button>
                                <button onclick="editItem(${item.id})" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors" title="Bearbeiten">‚úèÔ∏è</button>
                                <button onclick="deleteItem(${item.id})" class="bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700 transition-colors" title="L√∂schen">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Add item form
        const addItemForm = document.getElementById('add-item-form');
        if (addItemForm) {
            addItemForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const editId = this.dataset.editId;
                
                const formData = {
                    name: document.getElementById('item-name')?.value?.trim() || '',
                    barcode: document.getElementById('item-barcode')?.value?.trim() || '',
                    quantity: parseInt(document.getElementById('item-quantity')?.value) || 0,
                    price: parseFloat(document.getElementById('item-price')?.value) || 0,
                    category: document.getElementById('item-category')?.value || 'Sonstiges',
                    minStock: parseInt(document.getElementById('item-min-stock')?.value) || 0,
                    description: document.getElementById('item-description')?.value?.trim() || ''
                };
                
                // Validation
                if (!formData.name || !formData.barcode) {
                    showNotification('Name und Barcode sind erforderlich', 'error');
                    return;
                }
                
                if (editId) {
                    const item = inventory.find(item => item.id == editId);
                    if (item) {
                        const conflictItem = inventory.find(i => i.barcode === formData.barcode && i.id != editId);
                        if (conflictItem) {
                            showNotification('Ein anderer Artikel mit diesem Barcode existiert bereits!', 'error');
                            return;
                        }
                        
                        Object.assign(item, formData);
                        item.image = getCategoryEmoji(formData.category);
                        
                        saveInventory();
                        updateAllViews();
                        showNotification(`Artikel "${item.name}" aktualisiert`, 'success');
                    }
                } else {
                    const existingItem = inventory.find(item => item.barcode === formData.barcode);
                    if (existingItem) {
                        const updateExisting = confirm(`Artikel mit Barcode ${formData.barcode} existiert bereits:\n"${existingItem.name}"\n\nM√∂chten Sie den bestehenden Artikel aktualisieren?`);
                        if (updateExisting) {
                            Object.assign(existingItem, formData);
                            existingItem.image = getCategoryEmoji(formData.category);
                            saveInventory();
                            updateAllViews();
                            showNotification(`Artikel "${existingItem.name}" aktualisiert`, 'success');
                        } else {
                            return;
                        }
                    } else {
                        const newItem = {
                            id: Date.now() + Math.random(),
                            ...formData,
                            image: getCategoryEmoji(formData.category)
                        };
                        
                        inventory.push(newItem);
                        saveInventory();
                        updateAllViews();
                        showNotification(`Artikel "${newItem.name}" hinzugef√ºgt`, 'success');
                    }
                }
                
                // Reset form komplett
                setTimeout(() => {
                    this.reset();
                    delete this.dataset.editId;
                    
                    // Alle Felder explizit leeren
                    const fields = ['item-name', 'item-barcode', 'item-quantity', 'item-price', 'item-min-stock', 'item-description'];
                    fields.forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field) field.value = '';
                    });
                    
                    // Kategorie zur√ºcksetzen
                    const categoryField = document.getElementById('item-category');
                    if (categoryField) categoryField.value = 'Raketen';
                    
                    // Button zur√ºcksetzen
                    const submitBtn = this.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.textContent = '‚ûï Artikel hinzuf√ºgen';
                        submitBtn.className = 'bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors';
                    }
                }, 100);
                
                showTab('inventory');
            });
        }

        // Reports
        function updateReports() {
            if (!Array.isArray(inventory)) return;
            
            const totalItems = inventory.reduce((sum, item) => sum + (item.quantity || 0), 0);
            const totalValue = inventory.reduce((sum, item) => sum + ((item.quantity || 0) * (item.price || 0)), 0);
            const lowStockItems = inventory.filter(item => (item.quantity || 0) <= (item.minStock || 0));
            const categories = [...new Set(inventory.map(item => item.category || 'Sonstiges'))];
            
            const totalItemsEl = document.getElementById('total-items');
            const totalValueEl = document.getElementById('total-value');
            const lowStockCountEl = document.getElementById('low-stock-count');
            const categoryCountEl = document.getElementById('category-count');
            
            if (totalItemsEl) totalItemsEl.textContent = totalItems;
            if (totalValueEl) totalValueEl.textContent = `‚Ç¨${totalValue.toFixed(2)}`;
            if (lowStockCountEl) lowStockCountEl.textContent = lowStockItems.length;
            if (categoryCountEl) categoryCountEl.textContent = categories.length;
            
            const lowStockDiv = document.getElementById('low-stock-items');
            if (lowStockDiv) {
                if (lowStockItems.length > 0) {
                    lowStockDiv.innerHTML = lowStockItems.map(item => `
                        <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg border border-red-200">
                            <div class="flex items-center">
                                <span class="text-xl mr-3">${item.image || 'üì¶'}</span>
                                <div>
                                    <div class="font-medium">${escapeHtml(item.name || '')}</div>
                                    <div class="text-sm text-gray-600">Bestand: ${item.quantity || 0} / Min: ${item.minStock || 0}</div>
                                    <div class="text-xs text-gray-500">${escapeHtml(item.category || 'Sonstiges')}</div>
                                </div>
                            </div>
                            <button onclick="showTab('scanner'); document.getElementById('barcode-input').value='${escapeHtml(item.barcode || '')}'; scanBarcode();" 
                                    class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition-colors">
                                Auff√ºllen
                            </button>
                        </div>
                    `).join('');
                } else {
                    lowStockDiv.innerHTML = '<p class="text-gray-500 text-center py-4">‚úÖ Alle Artikel haben ausreichend Bestand</p>';
                }
            }
        }

        // Utility functions
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        function getCategoryEmoji(category) {
            const emojis = {
                'Raketen': 'üöÄ',
                'Batterien': 'üîã',
                'R√∂mische Lichter': 'üí°',
                'Font√§nen': '‚õ≤',
                'Bengalos': 'üî•',
                'Knaller': 'üí•',
                'Verbundfeuerwerk': 'üéÜ',
                'Sonstiges': 'üì¶'
            };
            return emojis[category] || 'üì¶';
        }

        function updateSyncStatus(message) {
            const statusElement = document.getElementById('sync-status');
            if (statusElement) {
                statusElement.textContent = message;
                
                setTimeout(() => {
                    statusElement.textContent = 'üîÑ Bereit';
                }, 3000);
            }
        }

        function addNewItemWithBarcode(barcode) {
            showTab('add-item');
            const barcodeInput = document.getElementById('item-barcode');
            const nameInput = document.getElementById('item-name');
            
            if (barcodeInput) barcodeInput.value = barcode;
            if (nameInput) nameInput.focus();
        }

        function editItem(itemId) {
            const item = inventory.find(item => item.id === itemId);
            if (!item) {
                showNotification('Artikel nicht gefunden', 'error');
                return;
            }
            
            console.log('Bearbeite Artikel:', item);
            
            showTab('add-item');
            
            // Warte kurz bis Tab gewechselt ist
            setTimeout(() => {
                // Alle Felder mit korrekten Werten f√ºllen
                const nameField = document.getElementById('item-name');
                const barcodeField = document.getElementById('item-barcode');
                const quantityField = document.getElementById('item-quantity');
                const priceField = document.getElementById('item-price');
                const categoryField = document.getElementById('item-category');
                const minStockField = document.getElementById('item-min-stock');
                const descriptionField = document.getElementById('item-description');
                
                if (nameField) nameField.value = item.name || '';
                if (barcodeField) barcodeField.value = item.barcode || '';
                if (quantityField) quantityField.value = item.quantity || 0;
                if (priceField) priceField.value = item.price || 0;
                if (categoryField) categoryField.value = item.category || 'Sonstiges';
                if (minStockField) minStockField.value = item.minStock || 0;
                if (descriptionField) descriptionField.value = item.description || '';
                
                // Form f√ºr Bearbeitung konfigurieren
                const form = document.getElementById('add-item-form');
                const submitBtn = form?.querySelector('button[type="submit"]');
                
                if (form) {
                    form.dataset.editId = itemId;
                    console.log('Edit ID gesetzt:', itemId);
                }
                
                if (submitBtn) {
                    submitBtn.textContent = '‚úèÔ∏è Artikel aktualisieren';
                    submitBtn.className = 'bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 transition-colors';
                }
                
                // Fokus auf Name-Feld setzen
                if (nameField) nameField.focus();
                
                showNotification(`Bearbeite: ${item.name}`, 'info');
            }, 100);
        }

        function deleteItem(itemId) {
            try {
                const item = inventory.find(item => item.id == itemId);
                if (!item) {
                    showNotification('Artikel nicht gefunden', 'error');
                    return;
                }
                
                const confirmMessage = `Artikel wirklich l√∂schen?\n\n` +
                    `Name: ${item.name}\n` +
                    `Barcode: ${item.barcode}\n` +
                    `Bestand: ${item.quantity || 0}\n` +
                    `Wert: ‚Ç¨${((item.quantity || 0) * (item.price || 0)).toFixed(2)}`;
                
                if (confirm(confirmMessage)) {
                    const itemName = item.name;
                    inventory = inventory.filter(item => item.id != itemId);
                    
                    if (saveInventory()) {
                        updateAllViews();
                        showNotification(`üóëÔ∏è Artikel "${itemName}" gel√∂scht`, 'success');
                    } else {
                        showNotification('Fehler beim L√∂schen des Artikels', 'error');
                    }
                }
            } catch (error) {
                console.error('Error deleting item:', error);
                showNotification('Fehler beim L√∂schen des Artikels', 'error');
            }
        }

        function importExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showNotification('Excel-Datei wird verarbeitet...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let workbook;
                    let jsonData = [];
                    
                    // Verschiedene Dateiformate unterst√ºtzen
                    if (file.name.toLowerCase().endsWith('.csv')) {
                        // CSV-Datei verarbeiten
                        const csvText = e.target.result;
                        if (!csvText || typeof csvText !== 'string') {
                            showNotification('CSV-Datei konnte nicht gelesen werden', 'error');
                            return;
                        }
                        
                        const lines = csvText.split('\n').filter(line => line.trim());
                        
                        if (lines.length < 2) {
                            showNotification('CSV-Datei muss mindestens eine Kopfzeile und eine Datenzeile haben', 'error');
                            return;
                        }
                        
                        const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim()).filter(h => h);
                        if (headers.length === 0) {
                            showNotification('Keine g√ºltigen Spalten√ºberschriften gefunden', 'error');
                            return;
                        }
                        
                        jsonData = [];
                        
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
                            const row = {};
                            headers.forEach((header, index) => {
                                row[header] = values[index] || '';
                            });
                            jsonData.push(row);
                        }
                    } else {
                        // Excel-Datei verarbeiten
                        if (!window.XLSX) {
                            showNotification('Excel-Bibliothek nicht verf√ºgbar', 'error');
                            return;
                        }
                        
                        const data = new Uint8Array(e.target.result);
                        workbook = XLSX.read(data, { 
                            type: 'array',
                            cellDates: true,
                            cellNF: false,
                            cellText: false
                        });
                        
                        if (!workbook || !workbook.SheetNames || workbook.SheetNames.length === 0) {
                            showNotification('Excel-Datei enth√§lt keine Arbeitsbl√§tter', 'error');
                            return;
                        }
                        
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        if (!worksheet) {
                            showNotification('Arbeitsblatt konnte nicht gelesen werden', 'error');
                            return;
                        }
                        
                        const rawData = XLSX.utils.sheet_to_json(worksheet, {
                            header: 1,
                            defval: '',
                            blankrows: false
                        });
                        
                        // Erste Zeile als Header verwenden
                        if (!rawData || rawData.length < 2) {
                            showNotification('Excel-Datei muss mindestens eine Kopfzeile und eine Datenzeile haben', 'error');
                            return;
                        }
                        
                        const headers = rawData[0].filter(h => h && String(h).trim());
                        if (headers.length === 0) {
                            showNotification('Keine g√ºltigen Spalten√ºberschriften gefunden', 'error');
                            return;
                        }
                        
                        const dataRows = rawData.slice(1);
                        
                        jsonData = dataRows.map(row => {
                            const obj = {};
                            headers.forEach((header, index) => {
                                obj[String(header)] = row[index] || '';
                            });
                            return obj;
                        }).filter(row => Object.values(row).some(val => val && String(val).trim()));
                    }
                    
                    if (!jsonData || jsonData.length === 0) {
                        showNotification('Datei ist leer oder enth√§lt keine g√ºltigen Daten', 'error');
                        return;
                    }
                    
                    console.log('Gefundene Spalten:', Object.keys(jsonData[0]));
                    console.log('Erste Datenzeile:', jsonData[0]);
                    
                    let importedCount = 0;
                    let updatedCount = 0;
                    let errorCount = 0;
                    const errors = [];
                    
                    jsonData.forEach((row, index) => {
                        try {
                            // Sicherheitspr√ºfung f√ºr row
                            if (!row || typeof row !== 'object') {
                                errors.push(`Zeile ${index + 2}: Ung√ºltige Datenzeile`);
                                errorCount++;
                                return;
                            }
                            
                            // Alle m√∂glichen Spaltennamen f√ºr flexible Erkennung
                            const nameFields = ['Name', 'name', 'Artikelname', 'artikel', 'Artikel', 'Produktname', 'Product', 'Item'];
                            const barcodeFields = ['Barcode', 'barcode', 'EAN', 'ean', 'Code', 'code', 'SKU', 'sku'];
                            const quantityFields = ['Anzahl', 'anzahl', 'Menge', 'menge', 'Bestand', 'bestand', 'Quantity', 'quantity', 'Stock', 'stock'];
                            const priceFields = ['Preis', 'preis', 'Price', 'price', 'Kosten', 'kosten', 'Cost', 'cost'];
                            const categoryFields = ['Kategorie', 'kategorie', 'Category', 'category', 'Typ', 'typ', 'Type', 'type'];
                            const minStockFields = ['Mindestbestand', 'mindestbestand', 'MinStock', 'minstock', 'Min', 'min'];
                            const descriptionFields = ['Beschreibung', 'beschreibung', 'Description', 'description', 'Details', 'details'];
                            
                            // Hilfsfunktion f√ºr sichere Feldextraktion
                            function findFieldValue(fields, defaultValue = '') {
                                for (const field of fields) {
                                    if (row.hasOwnProperty(field) && row[field] !== null && row[field] !== undefined) {
                                        const value = String(row[field]).trim();
                                        if (value) return value;
                                    }
                                }
                                return defaultValue;
                            }
                            
                            // Werte aus der Zeile extrahieren
                            const name = findFieldValue(nameFields);
                            const barcode = findFieldValue(barcodeFields);
                            const quantityStr = findFieldValue(quantityFields, '0');
                            const priceStr = findFieldValue(priceFields, '0');
                            const category = findFieldValue(categoryFields, 'Sonstiges');
                            const minStockStr = findFieldValue(minStockFields, '5');
                            const description = findFieldValue(descriptionFields);
                            
                            // Zahlen sicher konvertieren
                            let quantity = 0;
                            let price = 0;
                            let minStock = 5;
                            
                            try {
                                const cleanQuantity = String(quantityStr).replace(/[^\d]/g, '');
                                quantity = cleanQuantity ? parseInt(cleanQuantity) : 0;
                                if (isNaN(quantity) || quantity < 0) quantity = 0;
                            } catch (e) {
                                quantity = 0;
                            }
                            
                            try {
                                const cleanPrice = String(priceStr).replace(/[^\d.,]/g, '').replace(',', '.');
                                price = cleanPrice ? parseFloat(cleanPrice) : 0;
                                if (isNaN(price) || price < 0) price = 0;
                            } catch (e) {
                                price = 0;
                            }
                            
                            try {
                                const cleanMinStock = String(minStockStr).replace(/[^\d]/g, '');
                                minStock = cleanMinStock ? parseInt(cleanMinStock) : 5;
                                if (isNaN(minStock) || minStock < 0) minStock = 5;
                            } catch (e) {
                                minStock = 5;
                            }
                            
                            // Validierung
                            if (!name || name.length < 1) {
                                errors.push(`Zeile ${index + 2}: Artikelname fehlt oder ist leer`);
                                errorCount++;
                                return;
                            }
                            
                            if (!barcode || barcode.length < 3) {
                                errors.push(`Zeile ${index + 2}: Barcode "${barcode}" fehlt oder ist zu kurz (min. 3 Zeichen)`);
                                errorCount++;
                                return;
                            }
                            
                            // Sicherstellen dass inventory ein Array ist
                            if (!Array.isArray(inventory)) {
                                inventory = [];
                            }
                            
                            const existingItem = inventory.find(item => item && item.barcode === barcode);
                            
                            if (existingItem) {
                                // Artikel aktualisieren
                                try {
                                    existingItem.name = name;
                                    existingItem.quantity = quantity;
                                    existingItem.price = price;
                                    existingItem.category = category;
                                    existingItem.minStock = minStock;
                                    existingItem.description = description;
                                    existingItem.image = getCategoryEmoji(category);
                                    updatedCount++;
                                } catch (updateError) {
                                    errors.push(`Zeile ${index + 2}: Fehler beim Aktualisieren - ${updateError.message}`);
                                    errorCount++;
                                }
                            } else {
                                // Neuen Artikel hinzuf√ºgen
                                try {
                                    const newItem = {
                                        id: Date.now() + Math.random() * 1000 + index,
                                        name: name,
                                        barcode: barcode,
                                        quantity: quantity,
                                        price: price,
                                        category: category,
                                        minStock: minStock,
                                        description: description,
                                        image: getCategoryEmoji(category)
                                    };
                                    
                                    // Validierung des neuen Items
                                    if (newItem.id && newItem.name && newItem.barcode) {
                                        inventory.push(newItem);
                                        importedCount++;
                                    } else {
                                        throw new Error('Unvollst√§ndige Artikeldaten');
                                    }
                                } catch (createError) {
                                    errors.push(`Zeile ${index + 2}: Fehler beim Erstellen - ${createError.message}`);
                                    errorCount++;
                                }
                            }
                        } catch (error) {
                            console.error(`Fehler in Zeile ${index + 2}:`, error);
                            errors.push(`Zeile ${index + 2}: ${error.message}`);
                            errorCount++;
                        }
                    });
                    
                    // Daten speichern und Views aktualisieren
                    try {
                        if (importedCount > 0 || updatedCount > 0) {
                            const saveSuccess = saveInventory();
                            if (saveSuccess) {
                                updateAllViews();
                            } else {
                                throw new Error('Fehler beim Speichern der Daten');
                            }
                        }
                    } catch (saveError) {
                        console.error('Save error:', saveError);
                        showNotification('Fehler beim Speichern der importierten Daten', 'error');
                        return;
                    }
                    
                    // Erfolgsmeldung zusammenstellen
                    let message = `Import abgeschlossen!`;
                    const messageParts = [];
                    
                    if (importedCount > 0) messageParts.push(`‚úÖ ${importedCount} neue Artikel`);
                    if (updatedCount > 0) messageParts.push(`üîÑ ${updatedCount} aktualisiert`);
                    if (errorCount > 0) messageParts.push(`‚ö†Ô∏è ${errorCount} Fehler`);
                    
                    if (messageParts.length > 0) {
                        message += ' ' + messageParts.join(', ');
                    }
                    
                    // Detaillierte Fehlerausgabe in Konsole
                    if (errorCount > 0 && errors.length > 0) {
                        console.group('üìã Import-Fehler Details:');
                        errors.forEach(error => console.warn(error));
                        console.groupEnd();
                    }
                    
                    // Benachrichtigung anzeigen
                    const notificationType = (importedCount > 0 || updatedCount > 0) ? 'success' : 
                                           errorCount > 0 ? 'error' : 'info';
                    showNotification(message, notificationType);
                    
                } catch (error) {
                    console.error('Excel/CSV import error:', error);
                    showNotification(`Fehler beim Lesen der Datei: ${error.message}`, 'error');
                }
            };
            
            // Dateityp erkennen und entsprechend lesen
            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsArrayBuffer(file);
            }
            
            event.target.value = ''; // Reset file input
        }

        function exportInventory() {
            try {
                const csvContent = "data:text/csv;charset=utf-8," 
                    + "Name,Barcode,Anzahl,Preis,Kategorie,Mindestbestand,Beschreibung,Gesamtwert\n"
                    + inventory.map(item => 
                        `"${escapeHtml(item.name || '')}","${escapeHtml(item.barcode || '')}",${item.quantity || 0},${(item.price || 0).toFixed(2)},"${escapeHtml(item.category || '')}",${item.minStock || 0},"${escapeHtml(item.description || '')}",${((item.quantity || 0) * (item.price || 0)).toFixed(2)}`
                    ).join("\n");
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `inventar_export_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('Inventar als CSV exportiert', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Fehler beim Export', 'error');
            }
        }

        // Tab management
        function showTab(tabName) {
            if (isScanning && tabName !== 'scanner') {
                stopCamera();
            }
            
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                btn.classList.add('text-gray-500');
            });
            
            const tabContent = document.getElementById(tabName + '-tab');
            if (tabContent) tabContent.classList.remove('hidden');
            
            const activeBtn = document.getElementById('tab-' + tabName);
            if (activeBtn) {
                activeBtn.classList.remove('text-gray-500');
                activeBtn.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            }
            
            // Update content based on active tab
            switch(tabName) {
                case 'inventory':
                    updateInventoryTable();
                    break;
                case 'reports':
                    updateReports();
                    break;
            }
        }

        // Update all views
        function updateAllViews() {
            updateInventoryTable();
            updateReports();
        }

        // Event listeners
        function setupEventListeners() {
            const searchInput = document.getElementById('search-inventory');
            if (searchInput) {
                searchInput.addEventListener('input', updateInventoryTable);
            }
            
            const barcodeInput = document.getElementById('barcode-input');
            if (barcodeInput) {
                barcodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        scanBarcode();
                    }
                });
            }
        }

        // Auto-sync on load
        window.addEventListener('load', async function() {
            setupEventListeners();
            updateAllViews();
            
            if (githubSync.token && githubSync.repo) {
                try {
                    showNotification('Auto-Sync wird gestartet...', 'info');
                    await githubSync.autoSync();
                    updateSyncStatus('üîÑ Auto-Sync aktiv');
                    showNotification('Auto-Sync erfolgreich', 'success');
                } catch (error) {
                    console.error('Auto-sync failed:', error);
                    showNotification('Auto-Sync fehlgeschlagen', 'error');
                }
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98a3c5b091e8dc91',t:'MTc1OTczOTE2OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
