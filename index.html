<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyrotechnik Lager Manager Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <style>
        /* Allgemeine Stile und Animationen */
        body { box-sizing: border-box; }
        .scanner-line { animation: scan 2s linear infinite; }
        @keyframes scan {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(300px); }
        }
        .notification {
            position: fixed; top: 20px; right: 20px; z-index: 1000; padding: 12px 24px;
            border-radius: 8px; color: white; font-weight: 500; transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .notification.show { transform: translateX(0); }
        .notification.success { background-color: #10b981; }
        .notification.error { background-color: #ef4444; }
        .notification.info { background-color: #3b82f6; }
        .image-preview { max-width: 100px; max-height: 100px; object-fit: cover; border-radius: 8px; }
        .stocktaking-item { transition: all 0.3s ease; }
        .stocktaking-item.completed { background-color: #f0f9ff; border-left: 4px solid #10b981; }
        .github-pages-ready { min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .container-fluid { max-width: 1400px; margin: 0 auto; }
        @media (max-width: 768px) {
            .notification { right: 10px; left: 10px; transform: translateY(-100px); }
            .notification.show { transform: translateY(0); }
        }
        /* Druckstil fÃ¼r Code-Generierung */
        @media print {
            body > *:not(.print-container) { display: none; }
            .print-container { display: block; position: absolute; top: 0; left: 0; width: 100%; height: auto; }
            .print-item { page-break-after: always; margin: 10mm; padding: 5mm; border: 1px solid #ccc; width: 80mm; height: 50mm; box-sizing: border-box; float: left; }
        }
    </style>
</head>
<body class="github-pages-ready">

    <div id="notification-container"></div>

    <div class="container-fluid px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ† Pyrotechnik Lager Manager Pro</h1>
                    <p class="text-gray-600">Verwalten Sie Ihr Pyrotechnik-Inventar mit Bestandsaufnahme, Bildupload und Code-Generator</p>
                    <div class="mt-2 text-sm text-green-600 bg-green-50 px-3 py-1 rounded-full inline-block">
                        âœ… GitHub Pages Ready - VollstÃ¤ndig funktionsfÃ¤hig
                    </div>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <div class="flex items-center gap-2">
                        <span id="sync-status" class="text-sm text-gray-500">ğŸ”„ Synchronisiert</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="exportToCloud()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm transition-colors">
                            â˜ï¸ Backup erstellen
                        </button>
                        <button onclick="importFromCloud()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm transition-colors">
                            ğŸ“¥ Backup laden
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg mb-8">
            <div class="flex flex-wrap border-b overflow-x-auto">
                <button onclick="showTab('scanner')" id="tab-scanner" class="px-6 py-4 font-medium text-blue-600 border-b-2 border-blue-600 whitespace-nowrap">
                    ğŸ“± Scanner
                </button>
                <button onclick="showTab('inventory')" id="tab-inventory" class="px-6 py-4 font-medium text-gray-500 hover:text-blue-600 whitespace-nowrap">
                    ğŸ“‹ Inventar
                </button>
                <button onclick="showTab('stocktaking')" id="tab-stocktaking" class="px-6 py-4 font-medium text-gray-500 hover:text-blue-600 whitespace-nowrap">
                    ğŸ“Š Bestandsaufnahme
                </button>
                <button onclick="showTab('add-item')" id="tab-add-item" class="px-6 py-4 font-medium text-gray-500 hover:text-blue-600 whitespace-nowrap">
                    â• Artikel hinzufÃ¼gen
                </button>
                <button onclick="showTab('code-generator')" id="tab-code-generator" class="px-6 py-4 font-medium text-gray-500 hover:text-blue-600 whitespace-nowrap">
                    ğŸ·ï¸ Code Generator
                </button>
                <button onclick="showTab('import')" id="tab-import" class="px-6 py-4 font-medium text-gray-500 hover:text-blue-600 whitespace-nowrap">
                    ğŸ“¥ Import
                </button>
                <button onclick="showTab('reports')" id="tab-reports" class="px-6 py-4 font-medium text-gray-500 hover:text-blue-600 whitespace-nowrap">
                    ğŸ“Š Berichte
                </button>
            </div>
        </div>

        <div id="scanner-tab" class="tab-content">
            <div class="grid lg:grid-cols-2 gap-8">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ” Barcode Scanner</h2>

                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">ğŸ“¹ Live Kamera Scanner</h3>
                        <div class="relative bg-gray-900 rounded-lg p-4 mb-4" style="height: 300px;">
                            <video id="camera-video" class="w-full h-full object-cover rounded" autoplay playsinline muted></video>
                            <div id="scanner-placeholder" class="absolute inset-4 border-2 border-green-400 rounded-lg flex flex-col items-center justify-center">
                                <div class="absolute inset-4 border-2 border-green-400 rounded-lg">
                                    <div class="scanner-line absolute w-full h-1 bg-green-400 opacity-70"></div>
                                </div>
                                <p class="text-green-400 text-sm mt-20">Kamera starten um Barcodes zu scannen</p>
                            </div>
                            <div id="scan-overlay" class="absolute inset-4 border-2 border-green-400 rounded-lg hidden">
                                <div class="scanner-line absolute w-full h-1 bg-green-400 opacity-70"></div>
                            </div>
                        </div>
                        <button onclick="toggleCamera()" id="camera-toggle" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 mb-4 transition-colors">
                            ğŸ“· Kamera starten
                        </button>
                        <select id="camera-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 hidden"></select>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">ğŸ“¸ Barcode-Foto hochladen</h3>
                        <div class="border-2 border-dashed border-blue-300 rounded-lg p-6 text-center bg-blue-50 hover:bg-blue-100 transition-colors">
                            <input type="file" id="barcode-photo" accept="image/*" capture="environment" class="hidden" onchange="scanBarcodeFromImage(event)">
                            <label for="barcode-photo" class="cursor-pointer">
                                <div class="text-blue-500 mb-2">
                                    <svg class="mx-auto h-12 w-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                </div>
                                <p class="text-sm text-blue-600 font-medium">Foto von Barcode aufnehmen/hochladen</p>
                                <p class="text-xs text-gray-500 mt-1">Einfache Erkennung aus Bildern</p>
                            </label>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">âŒ¨ï¸ Manuelle Eingabe</h3>
                        <input type="text" id="barcode-input" placeholder="Barcode hier eingeben..."
                               class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               onkeypress="if(event.key === 'Enter') scanBarcode()">
                        <button onclick="scanBarcode()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors">
                            ğŸ” Suchen
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“„ Scan Ergebnis</h2>
                    <div id="scan-result" class="text-center text-gray-500 py-8">
                        Scannen Sie einen Barcode um Details anzuzeigen
                    </div>
                </div>
            </div>
        </div>

        <div id="inventory-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-xl font-bold text-gray-800">ğŸ“¦ Inventar Ãœbersicht</h2>
                    <div class="flex flex-col sm:flex-row gap-4 w-full md:w-auto">
                        <input type="text" id="search-inventory" placeholder="Artikel suchen..."
                               class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 flex-1 md:flex-none"
                               oninput="renderInventory()">
                        <button onclick="exportInventory()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            ğŸ“¥ Export CSV
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full table-auto min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Bild</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Artikel</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Barcode</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Bestand</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Preis</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Effektdauer</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table" class="divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="stocktaking-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-xl font-bold text-gray-800">ğŸ“Š Bestandsaufnahme</h2>
                    <div class="flex gap-2">
                        <button onclick="startStocktaking()" id="start-stocktaking-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            ğŸš€ Neue Aufnahme starten
                        </button>
                        <button onclick="exportStocktaking()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            ğŸ“¥ Export
                        </button>
                    </div>
                </div>

                <div id="stocktaking-progress" class="mb-6 hidden">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-blue-700">Fortschritt</span>
                            <span id="progress-text" class="text-sm text-blue-600">0 / 0</span>
                        </div>
                        <div class="w-full bg-blue-200 rounded-full h-2">
                            <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div id="stocktaking-scanner" class="mb-6 hidden">
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-yellow-800 mb-3">ğŸ“± Schnell-Scanner</h3>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input type="text" id="stocktaking-barcode" placeholder="Barcode scannen oder eingeben..."
                                   class="flex-1 p-3 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500"
                                   onkeypress="if(event.key === 'Enter') recordStockCount()">
                            <input type="number" id="stocktaking-count" placeholder="Anzahl" min="1" value="1"
                                   class="w-full sm:w-24 p-3 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                            <button onclick="recordStockCount()" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition-colors">
                                âœ“ Erfassen
                            </button>
                        </div>
                    </div>
                </div>

                <div id="stocktaking-list">
                    <p class="text-gray-500 text-center py-8">Keine aktive Bestandsaufnahme. Klicken Sie auf "Neue Aufnahme starten"</p>
                </div>
            </div>
        </div>

        <div id="add-item-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">â• Neuen Artikel hinzufÃ¼gen</h2>
                <form id="add-item-form" class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Artikelname *</label>
                        <input type="text" id="item-name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Barcode *</label>
                        <input type="text" id="item-barcode" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Anzahl *</label>
                        <input type="number" id="item-quantity" required min="0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Preis (â‚¬) *</label>
                        <input type="number" id="item-price" required min="0" step="0.01" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kategorie</label>
                        <select id="item-category" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="Raketen">ğŸš€ Raketen</option>
                            <option value="Batterien">ğŸ”‹ Batterien</option>
                            <option value="RÃ¶mische Lichter">ğŸ’¡ RÃ¶mische Lichter</option>
                            <option value="FontÃ¤nen">â›² FontÃ¤nen</option>
                            <option value="Bengalos">ğŸ”¥ Bengalos</option>
                            <option value="Knaller">ğŸ’¥ Knaller</option>
                            <option value="Verbundfeuerwerk">ğŸ† Verbundfeuerwerk</option>
                            <option value="Sonstiges">ğŸ“¦ Sonstiges</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mindestbestand</label>
                        <input type="number" id="item-min-stock" min="0" value="5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Effektdauer (Sekunden)</label>
                        <input type="number" id="item-duration" min="0" step="0.1" placeholder="z.B. 30" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Effekttyp</label>
                        <select id="item-effect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Effekt auswÃ¤hlen...</option>
                            <option value="Goldene Funken">âœ¨ Goldene Funken</option>
                            <option value="Bunte Sterne">ğŸŒŸ Bunte Sterne</option>
                            <option value="Silberne Kaskade">ğŸ’« Silberne Kaskade</option>
                            <option value="Rote Flamme">ğŸ”¥ Rote Flamme</option>
                            <option value="Blaue Sterne">ğŸ’™ Blaue Sterne</option>
                            <option value="GrÃ¼ne Funken">ğŸ’š GrÃ¼ne Funken</option>
                            <option value="Regenbogen">ğŸŒˆ Regenbogen</option>
                            <option value="Knalleffekt">ğŸ’¥ Knalleffekt</option>
                            <option value="Pfeifeffekt">ğŸµ Pfeifeffekt</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Artikelbild</label>
                        <div class="flex items-center gap-4">
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-blue-400 transition-colors flex-1">
                                <input type="file" id="item-image" accept="image/*" class="hidden" onchange="previewImage(event)">
                                <label for="item-image" class="cursor-pointer">
                                    <div class="text-gray-500 mb-2">
                                        <svg class="mx-auto h-8 w-8" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                    </div>
                                    <p class="text-sm text-gray-600">Foto hochladen</p>
                                </label>
                            </div>
                            <div id="image-preview" class="hidden">
                                <img id="preview-img" class="image-preview border-2 border-gray-200" alt="Vorschau">
                                <button type="button" onclick="removeImage()" class="mt-2 text-red-600 text-sm hover:text-red-800">Entfernen</button>
                            </div>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Beschreibung</label>
                        <textarea id="item-description" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                            Artikel hinzufÃ¼gen
                        </button>
                    </div>
                </form>
            </div>
        </div>


        <div id="code-generator-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">ğŸ·ï¸ Barcode & QR-Code Generator</h2>

                <div class="grid lg:grid-cols-2 gap-8">
                    <div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Code-Typ</label>
                            <select id="code-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="generateCode()">
                                <option value="qr">QR-Code</option>
                                <option value="ean13">EAN-13 Barcode</option>
                                <option value="code128">Code 128 Barcode</option>
                                <option value="code39">Code 39 Barcode</option>
                            </select>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Artikel auswÃ¤hlen</label>
                            <select id="code-item-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="document.getElementById('custom-code').value=this.value; generateCode()">
                                <option value="">Artikel auswÃ¤hlen...</option>
                            </select>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Oder eigenen Code eingeben</label>
                            <input type="text" id="custom-code" placeholder="Eigenen Code eingeben..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" oninput="generateCode()">
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">GrÃ¶ÃŸe</label>
                            <select id="code-size" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="generateCode()">
                                <option value="small">Klein (150px)</option>
                                <option value="medium" selected>Mittel (250px)</option>
                                <option value="large">GroÃŸ (400px)</option>
                            </select>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Etiketten-Layout</label>
                            <select id="label-layout" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="generateCode()">
                                <option value="simple">Nur Code</option>
                                <option value="with-text">Code + Text</option>
                                <option value="detailed">Detailliertes Etikett</option>
                            </select>
                        </div>

                        <button onclick="printCodes()" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors">
                            ğŸ–¨ï¸ Drucken
                        </button>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Generierter Code</h3>
                        <div id="generated-code-display" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center min-h-[300px] flex items-center justify-center">
                            <p class="text-gray-500">WÃ¤hlen Sie einen Artikel oder geben Sie einen Code ein</p>
                        </div>
                        <div id="code-actions" class="mt-4 hidden">
                            <div class="flex gap-2">
                                <button onclick="downloadCode()" class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                    ğŸ’¾ Download
                                </button>
                                <button onclick="copyCodeToClipboard()" class="flex-1 bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700 transition-colors">
                                    ğŸ“‹ Kopieren
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 border-t pt-8">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ“¦ Stapel-Generierung</h3>
                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kategorie filtern</label>
                            <select id="batch-category" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Alle Kategorien</option>
                                <option value="Raketen">ğŸš€ Raketen</option>
                                <option value="Batterien">ğŸ”‹ Batterien</option>
                                <option value="RÃ¶mische Lichter">ğŸ’¡ RÃ¶mische Lichter</option>
                                <option value="FontÃ¤nen">â›² FontÃ¤nen</option>
                                <option value="Bengalos">ğŸ”¥ Bengalos</option>
                                <option value="Knaller">ğŸ’¥ Knaller</option>
                                <option value="Verbundfeuerwerk">ğŸ† Verbundfeuerwerk</option>
                                <option value="Sonstiges">ğŸ“¦ Sonstiges</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nur niedrige BestÃ¤nde</label>
                            <input type="checkbox" id="batch-low-stock" class="mt-3 h-4 w-4 text-blue-600">
                        </div>
                        <div class="flex items-end">
                            <button onclick="generateBatchCodes()" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors">
                                ğŸ“‹ Alle generieren & drucken
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div id="import-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">ğŸ“¥ Daten Import</h2>
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ“Š CSV/Excel Datei importieren</h3>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors mb-4">
                        <input type="file" id="csv-file" accept=".csv,.xlsx,.xls" class="hidden" onchange="handleFileSelect(event)">
                        <label for="csv-file" class="cursor-pointer">
                            <div class="text-gray-500 mb-2">
                                <svg class="mx-auto h-12 w-12" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </div>
                            <p class="text-sm text-gray-600 font-medium">ğŸ“ Datei auswÃ¤hlen oder hierher ziehen</p>
                            <p class="text-xs text-gray-500 mt-1">UnterstÃ¼tzt: .csv, .xlsx, .xls</p>
                        </label>
                    </div>

                    <div id="column-mapping" class="hidden mb-6">
                        <h4 class="text-md font-semibold text-gray-700 mb-3">ğŸ”— Spalten-Zuordnung</h4>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p class="text-sm text-blue-700 mb-3">Ordnen Sie die Spalten aus Ihrer Datei den entsprechenden Feldern zu. Die erste Reihe dient als Vorschau:</p>
                            <div id="column-mapping-grid" class="grid md:grid-cols-2 gap-4">
                                </div>
                            <div class="flex gap-2 mt-4">
                                <button onclick="confirmImport()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                    âœ… Import bestÃ¤tigen
                                </button>
                                <button onclick="cancelImport()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                    âŒ Abbrechen
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="text-md font-semibold text-gray-700 mb-3">ğŸ“‹ UnterstÃ¼tzte Formate</h4>
                        <div class="grid md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <h5 class="font-medium text-gray-600 mb-2">Standard CSV Format:</h5>
                                <code class="text-xs bg-white p-2 rounded block">Name,Barcode,Anzahl,Preis,Kategorie,Mindestbestand,Beschreibung,Effektdauer,Effekttyp</code>
                            </div>
                            <div>
                                <h5 class="font-medium text-gray-600 mb-2">Flexible Spalten (automatisch erkannt):</h5>
                                <ul class="text-xs text-gray-600 space-y-1">
                                    <li>â€¢ Artikelname, Name, Bezeichnung</li>
                                    <li>â€¢ Barcode, EAN, Code, Artikel-Nr</li>
                                    <li>â€¢ Anzahl, Bestand, Menge, StÃ¼ck</li>
                                    <li>â€¢ Preis, Kosten, VK-Preis</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button onclick="downloadTemplate()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                ğŸ“¥ Excel-Vorlage herunterladen
                            </button>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ† Beispieldaten laden</h3>
                    <p class="text-gray-600 mb-4">Laden Sie vorgefertigte Pyrotechnik-Beispieldaten zum Testen</p>
                    <button onclick="loadSampleData()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        ğŸš€ Beispieldaten laden
                    </button>
                </div>
            </div>
        </div>


        <div id="reports-tab" class="tab-content hidden">
            <div class="grid lg:grid-cols-2 gap-8">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“Š Statistiken</h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-4 bg-blue-50 rounded-lg">
                            <span class="text-gray-700">Gesamtartikel:</span>
                            <span id="total-items" class="font-bold text-blue-600">0</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-green-50 rounded-lg">
                            <span class="text-gray-700">Gesamtwert:</span>
                            <span id="total-value" class="font-bold text-green-600">â‚¬0.00</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-red-50 rounded-lg">
                            <span class="text-gray-700">Niedrige BestÃ¤nde:</span>
                            <span id="low-stock-count" class="font-bold text-red-600">0</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-purple-50 rounded-lg">
                            <span class="text-gray-700">Kategorien:</span>
                            <span id="category-count" class="font-bold text-purple-600">0</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-yellow-50 rounded-lg">
                            <span class="text-gray-700">Ã˜ Effektdauer:</span>
                            <span id="avg-duration" class="font-bold text-yellow-600">0s</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">âš ï¸ Niedrige BestÃ¤nde</h2>
                    <div id="low-stock-items" class="space-y-2">
                        <p class="text-gray-500 text-center py-4">Keine Artikel mit niedrigem Bestand</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =======================================================
        // âš ï¸ WICHTIG: GITHUB-KONFIGURATION - FEHLER 401 BEHEBUNG
        // FÃœR DEN FEHLER 401 MÃœSSEN DIESE WERTE KORREKT SEIN!
        // =======================================================
        const CONFIG = {
            // ERSETZEN SIE DIESEN PLATZHALTER durch Ihren tatsÃ¤chlichen GitHub Personal Access Token (PAT).
            TOKEN: 'IHR_PERSOENLICHER_GITHUB_TOKEN',
            // ERSETZEN SIE DIESEN PLATZHALTER durch Ihren GitHub Benutzernamen.
            OWNER: 'IhrGenauerGitHubUsername',
            // ERSETZEN SIE DIESEN PLATZHALTER durch den Namen Ihres Repositorys (case-sensitive!).
            REPO: 'Pyrotechnik-Lager',
            FILE_PATH: 'data/inventory.json',
        };

        const BASE_URL = `https://api.github.com/repos/${CONFIG.OWNER}/${CONFIG.REPO}/contents/${CONFIG.FILE_PATH}`;

        let inventory = [];
        let currentStocktaking = null;
        let currentFileSha = null;
        let syncActive = true; 
        
        // Scanner-Variablen
        let codeReader = null;
        let cameraStream = null;

        // Import-Variablen
        let importedData = null;


        // =======================================================
        // HILFSFUNKTIONEN
        // =======================================================

        /** Zeigt eine temporÃ¤re Benachrichtigung an */
        function showNotification(message, type = 'info', duration = 3000) {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            container.appendChild(notification);

            setTimeout(() => { notification.classList.add('show'); }, 10);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    container.removeChild(notification);
                }, 300);
            }, duration);
        }

        /** Wechselt den angezeigten Tab */
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.flex-wrap button').forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-blue-600');
                btn.classList.add('text-gray-500');
            });

            document.getElementById(`${tabId}-tab`).classList.remove('hidden');
            const activeTabButton = document.getElementById(`tab-${tabId}`);
            if (activeTabButton) {
                activeTabButton.classList.remove('text-gray-500');
                activeTabButton.classList.add('text-blue-600', 'border-blue-600');
            }

            // Speziallogik
            if (tabId === 'inventory') {
                renderInventory();
                updateReports();
            }
            if (tabId === 'code-generator') {
                populateCodeGeneratorSelect();
                generateCode(); // Initialen Code generieren
            }
            if (tabId === 'scanner' && codeReader) {
                codeReader.reset(); // Scanner stoppen, wenn Tab gewechselt wird
                stopCamera();
            }
            if (tabId === 'stocktaking') {
                renderStocktakingList();
            }
        }

        // =======================================================
        // GITHUB SYNCHRONISIERUNG
        // =======================================================

        /** LÃ¤dt das Inventar von GitHub */
        async function fetchInventoryFromCloud() {
            if (CONFIG.TOKEN === 'IHR_PERSOENLICHER_GITHUB_TOKEN') {
                showNotification('GitHub-Synchronisierung deaktiviert: Bitte TOKEN in der Konfiguration setzen.', 'info');
                document.getElementById('sync-status').textContent = 'âš ï¸ Konfiguration fehlt';
                syncActive = false;
                return null;
            }

            document.getElementById('sync-status').textContent = 'ğŸ”„ LÃ¤dt...';
            syncActive = true;
            try {
                const response = await fetch(BASE_URL, {
                    method: 'GET',
                    headers: {
                        'Authorization': `token ${CONFIG.TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                    }
                });

                if (response.status === 404) {
                    showNotification('Erste Synchronisierung: Datei nicht gefunden. Erstelle eine neue Datei beim Speichern.', 'info');
                    document.getElementById('sync-status').textContent = 'âœ… Lokal geladen (neu)';
                    currentFileSha = null;
                    return [];
                }
                
                if (response.status === 401) {
                    syncActive = false;
                    document.getElementById('sync-status').textContent = 'âŒ Fehler 401 (Token/Repo)';
                    showNotification('Dauerhafter Fehler: HTTP 401. Bitte **TOKEN und REPO** prÃ¼fen. Speichern ist **deaktiviert**.', 'error', 15000);
                    throw new Error(`HTTP-Fehler beim Laden! Status: 401.`);
                }
                
                if (!response.ok) {
                    document.getElementById('sync-status').textContent = 'âŒ Fehler beim Laden';
                    throw new Error(`HTTP-Fehler! Status: ${response.status}.`);
                }

                const data = await response.json();
                const content = atob(data.content);
                currentFileSha = data.sha;
                
                showNotification('Inventar erfolgreich aus der Cloud (GitHub) geladen.', 'success');
                document.getElementById('sync-status').textContent = 'â˜ï¸ Zuletzt synchronisiert';
                return JSON.parse(content);
            } catch (error) {
                console.error('Fehler beim Laden von GitHub:', error);
                
                if (syncActive) { 
                    document.getElementById('sync-status').textContent = 'âš ï¸ Lokaler Modus';
                    showNotification(`Fehler beim Laden. Lokaler Modus: ${error.message}`, 'info', 5000);
                }
                return null;
            }
        }

        /** Speichert das Inventar auf GitHub */
        async function saveInventoryToCloud() {
            if (CONFIG.TOKEN === 'IHR_PERSOENLICHER_GITHUB_TOKEN') { return; }
            
            if (!syncActive) {
                showNotification('Speichern blockiert: Fehler 401 beim Laden. Bitte **Token/Repo** korrigieren.', 'error', 7000);
                return;
            }

            document.getElementById('sync-status').textContent = 'ğŸ”„ Speichert...';

            const content = JSON.stringify(inventory, null, 2);
            // Sicherstellen der korrekten Codierung fÃ¼r Base64
            const base64Content = btoa(unescape(encodeURIComponent(content)));

            const payload = {
                message: `Update inventory via Pyrotechnik Manager: ${new Date().toISOString()}`,
                content: base64Content,
                sha: currentFileSha
            };

            try {
                const response = await fetch(BASE_URL, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${CONFIG.TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.status === 401) {
                    syncActive = false;
                    document.getElementById('sync-status').textContent = 'âŒ Fehler 401 (Speichern)';
                    showNotification('Dauerhafter Fehler beim Speichern: HTTP 401. Bitte **TOKEN und REPO** prÃ¼fen. Speichern ist **deaktiviert**.', 'error', 15000);
                    throw new Error(`HTTP-Fehler beim Speichern! Status: 401.`);
                }

                if (!response.ok) {
                    document.getElementById('sync-status').textContent = 'âŒ Speicherfehler';
                    throw new Error(`HTTP-Fehler beim Speichern! Status: ${response.status}`);
                }

                const data = await response.json();
                currentFileSha = data.content.sha;

                showNotification('Inventar erfolgreich in der Cloud gespeichert.', 'success');
                document.getElementById('sync-status').textContent = 'âœ… Synchronisiert';
            } catch (error) {
                console.error('Fehler beim Speichern in GitHub:', error);
                document.getElementById('sync-status').textContent = 'âŒ Speicherfehler';
                showNotification(`Fehler beim Speichern in GitHub: ${error.message}`, 'error', 5000);
            }
        }

        /** Wrapper fÃ¼r Backup erstellen */
        function exportToCloud() { saveInventoryToCloud(); }
        
        /** Wrapper fÃ¼r Backup laden */
        async function importFromCloud() { await loadInventory(); }

        // =======================================================
        // INVENTAR LOKAL SPEICHERN & LADEN (Fallbacks)
        // =======================================================

        /** Speichert das Inventar lokal */
        function saveInventoryLocal() {
            localStorage.setItem('pyrotechnikInventory', JSON.stringify(inventory));
        }

        /** LÃ¤dt das Inventar (Cloud-PrioritÃ¤t) */
        async function loadInventory() {
            const cloudInventory = await fetchInventoryFromCloud();
            if (cloudInventory !== null) {
                inventory = cloudInventory;
            } else {
                const savedInventory = localStorage.getItem('pyrotechnikInventory');
                if (savedInventory) {
                    inventory = JSON.parse(savedInventory);
                    showNotification('Inventar aus lokalem Speicher geladen.', 'info');
                    if(syncActive) { document.getElementById('sync-status').textContent = 'âš ï¸ Nur lokal'; }
                } else {
                    inventory = [];
                    showNotification('Kein Inventar gefunden. Starten Sie mit der Eingabe.', 'info');
                }
            }
            renderInventory();
            updateReports();
        }

        /** FÃ¼gt einen neuen Artikel hinzu oder aktualisiert einen bestehenden */
        function updateInventory(updatedItem) {
            const index = inventory.findIndex(item => item.barcode === updatedItem.barcode);
            if (index > -1) {
                // Bei Edit aus dem Formular die Quantity nicht Ã¼berschreiben, es sei denn es ist eine explizite Quantity
                if (typeof updatedItem.quantity !== 'undefined') {
                    inventory[index] = updatedItem;
                } else {
                    // Update der Details (nicht der Quantity)
                    inventory[index] = { ...inventory[index], ...updatedItem };
                }
                showNotification('Artikel aktualisiert: ' + updatedItem.name, 'success');
            } else {
                inventory.push(updatedItem);
                showNotification('Neuer Artikel hinzugefÃ¼gt: ' + updatedItem.name, 'success');
            }
            saveInventoryLocal();
            saveInventoryToCloud();
            renderInventory();
            updateReports();
        }

        /** LÃ¶scht einen Artikel */
        function deleteItem(barcode) { 
            if (!confirm(`Wollen Sie den Artikel mit Barcode ${barcode} wirklich lÃ¶schen?`)) return;
            inventory = inventory.filter(item => item.barcode !== barcode);
            saveInventoryLocal();
            saveInventoryToCloud();
            renderInventory();
            updateReports();
            showNotification(`Artikel mit Barcode ${barcode} gelÃ¶scht.`, 'error');
        }

        // =======================================================
        // INVENTAR ANSICHT & EXPORT
        // =======================================================

        /** Rendert die Inventartabelle */
        function renderInventory() {
            const tableBody = document.getElementById('inventory-table');
            tableBody.innerHTML = '';
            const searchText = document.getElementById('search-inventory').value.toLowerCase();

            const filteredInventory = inventory.filter(item => 
                item.name.toLowerCase().includes(searchText) || 
                item.barcode.toLowerCase().includes(searchText) ||
                item.category.toLowerCase().includes(searchText)
            );

            filteredInventory.forEach(item => {
                const row = tableBody.insertRow();
                row.className = 'hover:bg-gray-100 transition-colors';

                const statusType = item.quantity <= item.minStock ? 'red' : 'green';
                const statusText = item.quantity <= item.minStock ? 'Niedrig' : 'OK';
                const status = `<span class="bg-${statusType}-100 text-${statusType}-800 text-xs font-medium px-2.5 py-0.5 rounded">${statusText} (${item.quantity})</span>`;

                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap"><img src="${item.image || ''}" class="image-preview" alt="Bild"></td>
                    <td class="px-4 py-4 font-medium text-gray-900">${item.name}</td>
                    <td class="px-4 py-4 text-sm text-gray-500">${item.barcode}</td>
                    <td class="px-4 py-4">${status}</td>
                    <td class="px-4 py-4 text-sm text-gray-500">${parseFloat(item.price).toFixed(2)} â‚¬</td>
                    <td class="px-4 py-4 text-sm text-gray-500">${item.duration ? item.duration + 's' : '-'}</td>
                    <td class="px-4 py-4 text-sm text-gray-500">${item.effect || item.category}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editItem('${item.barcode}')" class="text-indigo-600 hover:text-indigo-900 mr-2">Bearbeiten</button>
                        <button onclick="deleteItem('${item.barcode}')" class="text-red-600 hover:text-red-900">LÃ¶schen</button>
                    </td>
                `;
            });
        }

        /** Exportiert das Inventar als CSV */
        function exportInventory() {
            if (inventory.length === 0) {
                showNotification('Keine Daten zum Exportieren.', 'error');
                return;
            }

            const header = ["Name", "Barcode", "Anzahl", "Preis", "Kategorie", "Mindestbestand", "Effektdauer", "Effekttyp", "Beschreibung", "Bild-DataURL"];
            const rows = inventory.map(item => [
                item.name,
                item.barcode,
                item.quantity,
                item.price,
                item.category,
                item.minStock,
                item.duration,
                item.effect,
                item.description,
                item.image || ""
            ]);

            const data = [header, ...rows];
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Inventar");

            XLSX.writeFile(wb, `Pyrotechnik_Inventar_${new Date().toISOString().slice(0, 10)}.xlsx`);
            showNotification('Inventar erfolgreich als Excel-Datei exportiert.', 'success');
        }


        // =======================================================
        // ARTIKEL HINZUFÃœGEN & BEARBEITEN
        // =======================================================

        /** FÃ¼gt Artikel Ã¼ber das Formular hinzu */
        document.getElementById('add-item-form').onsubmit = function(e) {
            e.preventDefault();
            
            // Check, ob der Barcode bereits existiert, aber nur wenn es kein Edit-Vorgang ist
            const barcode = document.getElementById('item-barcode').value;
            const isEditing = this.dataset.editingBarcode === barcode;
            
            if (!isEditing && inventory.some(item => item.barcode === barcode)) {
                showNotification('Fehler: Ein Artikel mit diesem Barcode existiert bereits!', 'error', 5000);
                return;
            }

            const newItem = {
                name: document.getElementById('item-name').value,
                barcode: barcode,
                quantity: parseInt(document.getElementById('item-quantity').value) || 0,
                price: parseFloat(document.getElementById('item-price').value) || 0,
                category: document.getElementById('item-category').value,
                minStock: parseInt(document.getElementById('item-min-stock').value) || 0,
                duration: parseFloat(document.getElementById('item-duration').value) || null,
                effect: document.getElementById('item-effect').value,
                description: document.getElementById('item-description').value,
                image: document.getElementById('preview-img').src // Data URL
            };

            updateInventory(newItem);
            
            this.reset();
            this.removeAttribute('data-editing-barcode');
            document.getElementById('image-preview').classList.add('hidden');
            document.querySelector('#add-item-form button[type="submit"]').textContent = 'Artikel hinzufÃ¼gen';
        };

        /** FÃ¼llt das Formular fÃ¼r die Bearbeitung */
        function editItem(barcode) {
            const item = inventory.find(i => i.barcode === barcode);
            if (!item) return;

            // Navigiere zum HinzufÃ¼gen-Tab
            showTab('add-item');

            // FÃ¼lle die Felder
            document.getElementById('item-name').value = item.name;
            document.getElementById('item-barcode').value = item.barcode;
            document.getElementById('item-quantity').value = item.quantity;
            document.getElementById('item-price').value = item.price;
            document.getElementById('item-category').value = item.category;
            document.getElementById('item-min-stock').value = item.minStock;
            document.getElementById('item-duration').value = item.duration || '';
            document.getElementById('item-effect').value = item.effect || '';
            document.getElementById('item-description').value = item.description || '';
            
            // Bild-Vorschau
            if (item.image) {
                document.getElementById('preview-img').src = item.image;
                document.getElementById('image-preview').classList.remove('hidden');
            } else {
                removeImage();
            }

            // Kennzeichen fÃ¼r den Edit-Modus
            document.getElementById('add-item-form').dataset.editingBarcode = barcode;
            document.querySelector('#add-item-form button[type="submit"]').textContent = 'Artikel speichern';
            showNotification(`Bearbeite Artikel: ${item.name}`, 'info');
        }


        /** Zeigt die Bild-Vorschau */
        function previewImage(event) {
            const preview = document.getElementById('preview-img');
            const previewDiv = document.getElementById('image-preview');
            const file = event.target.files[0];
            const reader = new FileReader();

            reader.onloadend = function() {
                preview.src = reader.result;
                previewDiv.classList.remove('hidden');
            }
            if (file) { reader.readAsDataURL(file); }
        }

        /** Entfernt das Bild */
        function removeImage() {
            document.getElementById('preview-img').src = '';
            document.getElementById('item-image').value = '';
            document.getElementById('image-preview').classList.add('hidden');
        }

        // =======================================================
        // SCANNER (ZXing) IMPLEMENTIERUNG
        // =======================================================

        /** Startet/Stoppt die Kamera */
        async function toggleCamera() {
            const videoElement = document.getElementById('camera-video');
            const toggleButton = document.getElementById('camera-toggle');

            if (cameraStream) {
                stopCamera();
                toggleButton.textContent = 'ğŸ“· Kamera starten';
                toggleButton.classList.replace('bg-red-600', 'bg-green-600');
                return;
            }

            if (!codeReader) {
                codeReader = new ZXing.BrowserMultiFormatReader();
                const videoInputSelect = document.getElementById('camera-select');
                videoInputSelect.onchange = toggleCamera; // Neustart bei Wechsel
                
                // Kameras auflisten
                const devices = await codeReader.listVideoInputDevices();
                if (devices && devices.length > 0) {
                    videoInputSelect.innerHTML = devices.map(device => 
                        `<option value="${device.deviceId}">${device.label || `Kamera ${device.deviceId}`}</option>`
                    ).join('');
                    videoInputSelect.classList.remove('hidden');
                } else {
                    showNotification('Keine Kameras gefunden.', 'error');
                    return;
                }
            }
            
            const selectedDeviceId = document.getElementById('camera-select').value;

            try {
                // Kamera starten
                codeReader.decodeFromVideoDevice(selectedDeviceId, 'camera-video', (result, err) => {
                    if (result) {
                        showNotification(`Barcode erkannt: ${result.text}`, 'success');
                        scanBarcode(result.text); // Ergebnis verarbeiten
                        // Wenn der Scanner im Lager-Tab ist, gleich erfassen
                        if (document.getElementById('stocktaking-tab').classList.contains('hidden') === false) {
                            document.getElementById('stocktaking-barcode').value = result.text;
                            recordStockCount();
                        }
                    }
                    if (err && !(err instanceof ZXing.NotFoundException)) {
                        console.error(err);
                    }
                });

                // Stream speichern, um ihn spÃ¤ter stoppen zu kÃ¶nnen
                cameraStream = videoElement.srcObject; 
                
                videoElement.classList.remove('hidden');
                document.getElementById('scanner-placeholder').classList.add('hidden');
                document.getElementById('scan-overlay').classList.remove('hidden');
                toggleButton.textContent = 'ğŸ›‘ Kamera stoppen';
                toggleButton.classList.replace('bg-green-600', 'bg-red-600');
            } catch (error) {
                console.error(error);
                showNotification('Kamerastart fehlgeschlagen. Erlaubnis erteilen?', 'error');
                stopCamera();
            }
        }
        
        /** Stoppt den Kamerastream */
        function stopCamera() {
            if (codeReader) {
                codeReader.reset();
            }
            const videoElement = document.getElementById('camera-video');
            videoElement.classList.add('hidden');
            document.getElementById('scanner-placeholder').classList.remove('hidden');
            document.getElementById('scan-overlay').classList.add('hidden');
            cameraStream = null;
        }


        /** Scannt Barcode aus einem hochgeladenen Bild */
        async function scanBarcodeFromImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const image = new Image();
                image.onload = async () => {
                    try {
                        // Da die ZXing-Bibliothek geladen ist, verwenden wir sie zur Bildverarbeitung
                        const imgCodeReader = new ZXing.BrowserMultiFormatReader();
                        const result = await imgCodeReader.decodeFromImage(image);
                        showNotification(`Barcode erkannt: ${result.text}`, 'success');
                        scanBarcode(result.text);
                    } catch (err) {
                        showNotification('Kein Barcode im Bild erkannt.', 'error');
                        console.error(err);
                    }
                };
                image.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        /** Sucht und zeigt das Scan-Ergebnis an */
        function scanBarcode(code) {
            const resultDiv = document.getElementById('scan-result');
            const item = inventory.find(i => i.barcode === code);
            
            document.getElementById('barcode-input').value = code; // Code in Input setzen

            if (item) {
                resultDiv.innerHTML = `
                    <div class="flex flex-col md:flex-row gap-4 items-center p-4 bg-green-50 rounded-lg border-l-4 border-green-400 text-left">
                        <img src="${item.image || 'https://via.placeholder.com/100?text=Feuerwerk'}" class="image-preview flex-shrink-0" alt="Artikelbild">
                        <div class="flex-grow">
                            <h3 class="text-lg font-bold text-gray-900">${item.name}</h3>
                            <p class="text-sm text-gray-700 mb-2">**Barcode:** ${item.barcode}</p>
                            <p class="text-lg font-semibold text-green-600 mb-2">Bestand: ${item.quantity} StÃ¼ck</p>
                            <p class="text-sm text-gray-500">Wert: ${parseFloat(item.price).toFixed(2)} â‚¬ pro StÃ¼ck</p>
                            <button onclick="updateQuantity('${item.barcode}', 1)" class="mt-2 bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">+1 Bestand</button>
                            <button onclick="updateQuantity('${item.barcode}', -1)" class="mt-2 bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">-1 Bestand</button>
                        </div>
                    </div>
                `;
                showNotification(`Artikel gefunden: ${item.name}`, 'success');
            } else {
                resultDiv.innerHTML = `
                    <div class="p-4 bg-red-50 rounded-lg border-l-4 border-red-400">
                        <p class="font-bold text-red-800 mb-2">Artikel nicht gefunden!</p>
                        <p class="text-sm text-red-700">Barcode: ${code}</p>
                        <button onclick="showTab('add-item'); document.getElementById('item-barcode').value = '${code}'" class="mt-3 bg-red-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-700">
                            â• Neuen Artikel anlegen
                        </button>
                    </div>
                `;
                showNotification(`Code nicht gefunden: ${code}`, 'error');
            }
        }
        
        /** Aktualisiert die Bestandsmenge direkt aus dem Scan-Ergebnis */
        function updateQuantity(barcode, delta) {
            const item = inventory.find(i => i.barcode === barcode);
            if (item) {
                item.quantity = Math.max(0, item.quantity + delta);
                updateInventory(item);
                scanBarcode(barcode); // Ergebnisansicht neu laden
                showNotification(`Bestand von ${item.name} um ${delta} geÃ¤ndert. Neu: ${item.quantity}`, 'info');
            }
        }


        // =======================================================
        // BESTANDSAUFNAHME (STOCKTAKING)
        // =======================================================

        /** Startet eine neue Bestandsaufnahme */
        function startStocktaking() {
            if (inventory.length === 0) {
                showNotification('Keine Artikel im Inventar, um eine Bestandsaufnahme zu starten.', 'error');
                return;
            }
            
            currentStocktaking = inventory.map(item => ({
                ...item,
                physicalCount: 0,
                counted: false
            }));

            document.getElementById('stocktaking-progress').classList.remove('hidden');
            document.getElementById('stocktaking-scanner').classList.remove('hidden');
            document.getElementById('start-stocktaking-btn').textContent = 'ğŸ” Neu starten';
            showNotification('Neue Bestandsaufnahme gestartet.', 'info', 2000);
            renderStocktakingList();
        }

        /** Erfasst die gezÃ¤hlte Menge */
        function recordStockCount() {
            const barcodeInput = document.getElementById('stocktaking-barcode');
            const countInput = document.getElementById('stocktaking-count');
            const barcode = barcodeInput.value.trim();
            const count = parseInt(countInput.value) || 1;

            if (!currentStocktaking) {
                showNotification('Bitte starten Sie zuerst eine Bestandsaufnahme.', 'error');
                return;
            }

            const itemIndex = currentStocktaking.findIndex(item => item.barcode === barcode);

            if (itemIndex > -1) {
                const item = currentStocktaking[itemIndex];
                
                // ZÃ¤hler aktualisieren und als gezÃ¤hlt markieren
                item.physicalCount = count;
                item.counted = true;

                // Markiere den Artikel in der Liste als erledigt
                const listItem = document.querySelector(`#stocktaking-item-${barcode}`);
                if (listItem) listItem.classList.add('completed');

                showNotification(`${item.name}: ${count} StÃ¼ck erfasst.`, 'success');
            } else {
                showNotification(`Barcode ${barcode} in Aufnahme nicht gefunden.`, 'error');
            }
            
            barcodeInput.value = ''; // Input leeren
            countInput.value = 1;
            barcodeInput.focus();
            
            renderStocktakingList();
        }

        /** Rendert die Bestandsaufnahmeliste */
        function renderStocktakingList() {
            const listDiv = document.getElementById('stocktaking-list');
            
            if (!currentStocktaking || currentStocktaking.length === 0) {
                listDiv.innerHTML = '<p class="text-gray-500 text-center py-8">Keine aktive Bestandsaufnahme. Klicken Sie auf "Neue Aufnahme starten"</p>';
                return;
            }

            // Fortschritt berechnen
            const total = currentStocktaking.length;
            const counted = currentStocktaking.filter(item => item.counted).length;
            const percentage = (counted / total) * 100;
            document.getElementById('progress-text').textContent = `${counted} / ${total} Artikel gezÃ¤hlt`;
            document.getElementById('progress-bar').style.width = `${percentage}%`;

            let html = '<div class="space-y-3">';
            currentStocktaking.forEach(item => {
                const diff = (item.physicalCount || 0) - item.quantity;
                const diffClass = diff === 0 ? 'text-green-600' : (diff > 0 ? 'text-blue-600' : 'text-red-600');

                html += `
                    <div id="stocktaking-item-${item.barcode}" class="stocktaking-item p-4 border border-gray-200 rounded-lg flex justify-between items-center ${item.counted ? 'completed' : ''}">
                        <div>
                            <p class="font-medium text-gray-800">${item.name} (${item.barcode})</p>
                            <p class="text-sm text-gray-500">Soll-Bestand: ${item.quantity}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-lg">${item.physicalCount || '0'}</p>
                            <p class="text-sm ${diffClass}">Differenz: ${diff}</p>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            listDiv.innerHTML = html;
        }


        /** Exportiert die Bestandsaufnahme als CSV und fragt nach Aktualisierung */
        function exportStocktaking() {
            if (!currentStocktaking || currentStocktaking.length === 0) {
                showNotification('Keine aktive Bestandsaufnahme zum Exportieren.', 'error');
                return;
            }

            const header = ["Name", "Barcode", "Soll-Bestand", "Ist-Bestand", "Differenz", "GezÃ¤hlt"];
            const rows = currentStocktaking.map(item => [
                item.name,
                item.barcode,
                item.quantity,
                item.physicalCount,
                item.physicalCount - item.quantity,
                item.counted ? 'Ja' : 'Nein'
            ]);

            const data = [header, ...rows];
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Bestandsaufnahme");

            XLSX.writeFile(wb, `Bestandsaufnahme_${new Date().toISOString().slice(0, 10)}.xlsx`);
            showNotification('Bestandsaufnahme exportiert.', 'success');
            
            // Frage, ob das Inventar aktualisiert werden soll
            setTimeout(() => {
                if (confirm('MÃ¶chten Sie den Soll-Bestand im Inventar mit den gezÃ¤hlten Ist-BestÃ¤nden aktualisieren?')) {
                    currentStocktaking.forEach(item => {
                        if (item.counted && item.physicalCount !== item.quantity) {
                            // Erstelle ein Objekt nur mit den Feldern, die aktualisiert werden sollen (Barcode und Quantity)
                            const updateObj = {
                                barcode: item.barcode,
                                quantity: item.physicalCount,
                                // Hier keine weiteren Felder, da wir nur den Bestand aktualisieren wollen
                            };
                            updateInventory(updateObj);
                        }
                    });
                    showNotification('Inventar erfolgreich mit Ist-BestÃ¤nden aktualisiert!', 'success', 5000);
                    currentStocktaking = null; // Aufnahme abschlieÃŸen
                    showTab('inventory'); // Wechsel zur Inventar-Ansicht
                }
            }, 500);
        }

        // =======================================================
        // CODE GENERATOR
        // =======================================================

        /** FÃ¼llt das Dropdown im Code Generator */
        function populateCodeGeneratorSelect() {
            const select = document.getElementById('code-item-select');
            select.innerHTML = '<option value="">Artikel auswÃ¤hlen...</option>';
            inventory.forEach(item => {
                const option = document.createElement('option');
                option.value = item.barcode;
                option.textContent = `${item.name} (${item.barcode})`;
                select.appendChild(option);
            });
        }
        
        /** Generiert und zeigt den Code an (QR oder Barcode) */
        function generateCode() {
            const codeType = document.getElementById('code-type').value;
            const codeValue = document.getElementById('custom-code').value || document.getElementById('code-item-select').value;
            const size = document.getElementById('code-size').value;
            const layout = document.getElementById('label-layout').value;
            const display = document.getElementById('generated-code-display');
            const item = inventory.find(i => i.barcode === codeValue);
            
            const sizeMap = { 'small': 150, 'medium': 250, 'large': 400 };
            const sizePx = sizeMap[size];
            
            if (!codeValue) {
                display.innerHTML = '<p class="text-gray-500">WÃ¤hlen Sie einen Artikel oder geben Sie einen Code ein</p>';
                document.getElementById('code-actions').classList.add('hidden');
                return;
            }

            display.innerHTML = ''; // Vorherigen Code lÃ¶schen
            document.getElementById('code-actions').classList.remove('hidden');

            const itemInfo = item ? `
                <div class="text-center mt-2">
                    <p class="font-bold">${item.name}</p>
                    ${layout === 'detailed' ? `<p class="text-sm">Bestand: ${item.quantity}, Preis: ${item.price} â‚¬</p>` : ''}
                </div>
            ` : '';

            // Layout Container erstellen
            let container = document.createElement('div');
            container.className = 'flex flex-col items-center justify-center p-4';
            
            if (codeType === 'qr') {
                const canvas = document.createElement('canvas');
                canvas.width = sizePx;
                canvas.height = sizePx;
                QRCode.toCanvas(canvas, codeValue, { errorCorrectionLevel: 'H', width: sizePx }, (error) => {
                    if (error) console.error(error);
                    else {
                        container.appendChild(canvas);
                        if (layout !== 'simple') container.innerHTML += itemInfo;
                        display.appendChild(container);
                    }
                });
            } else {
                // Barcode
                const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                svg.id = 'barcode-svg';
                
                JsBarcode(svg, codeValue, {
                    format: codeType,
                    displayValue: layout !== 'simple',
                    text: layout === 'simple' ? undefined : codeValue,
                    width: sizePx / 250, // Skalierung relativ zur GrÃ¶ÃŸe
                    height: sizePx / 3,
                    margin: 0,
                    textMargin: 5
                });
                
                container.appendChild(svg);
                if (layout === 'with-text' && !svg.querySelector('text')) {
                     // Wenn JsBarcode text: false hatte, fÃ¼gen wir den Text manuell hinzu
                    container.innerHTML += `<div class="mt-2 text-sm">${codeValue}</div>`;
                }
                if (layout === 'detailed') container.innerHTML += itemInfo;
                display.appendChild(container);
            }
        }

        /** Druckt den generierten Code (oder mehrere Codes im Batch-Modus) */
        function printCodes(batchMode = false, codesToPrint = []) {
            let htmlToPrint = '';

            if (batchMode) {
                codesToPrint.forEach(item => {
                    const tempDiv = document.createElement('div');
                    tempDiv.className = 'print-item';
                    const barcode = item.barcode;
                    const codeType = document.getElementById('code-type').value;

                    // Erstelle Container fÃ¼r Code und Text
                    const codeContainer = document.createElement('div');
                    codeContainer.style.display = 'flex';
                    codeContainer.style.flexDirection = 'column';
                    codeContainer.style.alignItems = 'center';

                    const itemInfo = `
                        <div style="font-size: 10px; text-align: center; margin-top: 5px;">
                            <strong>${item.name}</strong><br>
                            Bestand: ${item.quantity}, Preis: ${item.price} â‚¬
                        </div>
                    `;

                    if (codeType === 'qr') {
                        const canvas = document.createElement('canvas');
                        canvas.width = 100;
                        canvas.height = 100;
                        QRCode.toCanvas(canvas, barcode, { errorCorrectionLevel: 'M', width: 100 }, (error) => {
                            if (!error) {
                                codeContainer.appendChild(canvas);
                                codeContainer.innerHTML += itemInfo;
                                tempDiv.appendChild(codeContainer);
                            }
                        });
                    } else {
                        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                        JsBarcode(svg, barcode, {
                            format: codeType,
                            displayValue: true,
                            width: 1,
                            height: 30,
                            margin: 0,
                            fontSize: 10
                        });
                        codeContainer.appendChild(svg);
                        codeContainer.innerHTML += itemInfo;
                        tempDiv.appendChild(codeContainer);
                    }
                    htmlToPrint += tempDiv.outerHTML;
                });
            } else {
                // Einzelcode-Druck
                const generatedDiv = document.getElementById('generated-code-display').cloneNode(true);
                generatedDiv.classList.remove('p-8');
                generatedDiv.style.border = 'none';
                generatedDiv.style.minHeight = 'auto';
                htmlToPrint = `<div class="print-item">${generatedDiv.innerHTML}</div>`;
            }

            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Etiketten Drucken</title>');
            printWindow.document.write('<style>@media print { .print-container { display: block; } .print-item { page-break-inside: avoid; margin: 10mm; padding: 5mm; border: 1px solid #ccc; width: 80mm; height: 50mm; box-sizing: border-box; float: left; } svg { display: block; margin: 0 auto; } }</style>');
            printWindow.document.write('</head><body><div class="print-container">');
            printWindow.document.write(htmlToPrint);
            printWindow.document.write('</div></body></html>');
            printWindow.document.close();
            printWindow.focus();
            
            // Warten, bis Bilder/SVGs gerendert sind
            setTimeout(() => { printWindow.print(); }, 500);
            showNotification('Druckvorgang gestartet.', 'info');
        }

        /** Generiert und druckt Codes im Stapel */
        function generateBatchCodes() {
            const category = document.getElementById('batch-category').value;
            const lowStock = document.getElementById('batch-low-stock').checked;
            
            let codesToPrint = inventory.filter(item => {
                let match = true;
                if (category && item.category !== category) match = false;
                if (lowStock && item.quantity > item.minStock) match = false;
                return match;
            });

            if (codesToPrint.length === 0) {
                showNotification('Keine Artikel fÃ¼r diesen Stapel-Filter gefunden.', 'error');
                return;
            }

            showNotification(`${codesToPrint.length} Etiketten werden gedruckt.`, 'info');
            printCodes(true, codesToPrint);
        }
        
        // =======================================================
        // DATEN IMPORT
        // =======================================================

        /** Behandelt die Dateiauswahl (CSV/XLSX) */
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                // Konvertiere in Array von Arrays (Raw Data)
                const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: true });
                
                if (json.length < 2) {
                    showNotification('Datei ist leer oder enthÃ¤lt nur Header.', 'error');
                    return;
                }
                
                const headers = json[0].map(h => String(h).trim());
                importedData = json.slice(1);
                
                const detectedMappings = autoDetectColumns(headers);
                showColumnMapping(headers, detectedMappings, importedData.slice(0, 3)); // Erste 3 Zeilen als Vorschau
                document.getElementById('column-mapping').classList.remove('hidden');
                showNotification('Datei geladen. Bitte Spalten zuordnen.', 'info', 5000);
            };
            reader.readAsArrayBuffer(file);
        }

        /** Automatische Spaltenerkennung */
        function autoDetectColumns(headers) {
            const mappings = {};
            const fieldMappings = {
                name: ['name', 'artikelname', 'bezeichnung', 'item'],
                barcode: ['barcode', 'ean', 'code', 'artikel-nr', 'artikelnr', 'artikelnummer', 'id'],
                quantity: ['anzahl', 'bestand', 'menge', 'stÃ¼ck', 'stock', 'qty', 'quantity'],
                price: ['preis', 'kosten', 'vk-preis', 'verkaufspreis', 'price', 'cost'],
                category: ['kategorie', 'gruppe', 'typ', 'category', 'group', 'type'],
                minStock: ['mindestbestand', 'min-bestand', 'minimum', 'min', 'minstock'],
                description: ['beschreibung', 'details', 'info', 'description', 'notes'],
                duration: ['dauer', 'effektdauer', 'brenndauer', 'duration', 'time'],
                effect: ['effekt', 'effekttyp', 'effect', 'type']
            };
            
            headers.forEach((header, index) => {
                const normalizedHeader = header.toLowerCase().trim();
                
                for (const [field, keywords] of Object.entries(fieldMappings)) {
                    if (keywords.some(keyword => normalizedHeader.includes(keyword))) {
                        mappings[field] = index;
                        break;
                    }
                }
            });
            
            return mappings;
        }

        /** Zeigt die Spaltenzuordnung an */
        function showColumnMapping(headers, detectedMappings, sampleRows) {
            const grid = document.getElementById('column-mapping-grid');
            grid.innerHTML = '';
            
            const fields = [
                { key: 'name', label: 'Artikelname', required: true },
                { key: 'barcode', label: 'Barcode', required: true },
                { key: 'quantity', label: 'Anzahl', required: true },
                { key: 'price', label: 'Preis (â‚¬)', required: true },
                { key: 'category', label: 'Kategorie', required: false },
                { key: 'minStock', label: 'Mindestbestand', required: false },
                { key: 'duration', label: 'Effektdauer (s)', required: false },
                { key: 'effect', label: 'Effekttyp', required: false },
                { key: 'description', label: 'Beschreibung', required: false },
            ];

            // Dropdown-Optionen
            const headerOptions = headers.map((h, i) => `<option value="${i}">${h} (Bsp: ${sampleRows[0][i]})</option>`).join('');

            fields.forEach(field => {
                const colIndex = detectedMappings[field.key];
                const requiredStar = field.required ? '<span class="text-red-500">*</span>' : '';
                
                const div = document.createElement('div');
                div.className = 'flex flex-col';
                div.innerHTML = `
                    <label class="text-sm font-medium text-gray-700 mb-1">${field.label} ${requiredStar}</label>
                    <select class="p-2 border border-gray-300 rounded-lg text-sm" data-field="${field.key}">
                        <option value="-1">Nicht importieren</option>
                        ${headerOptions}
                    </select>
                `;
                grid.appendChild(div);
                
                // Setze den automatisch erkannten Wert
                if (colIndex !== undefined) {
                    div.querySelector('select').value = colIndex;
                }
            });
        }

        /** BestÃ¤tigt den Import und verarbeitet die Daten */
        function confirmImport() {
            const mappingSelects = document.querySelectorAll('#column-mapping-grid select');
            const mappings = {};
            let hasError = false;

            // Mappings sammeln und Pflichtfelder prÃ¼fen
            mappingSelects.forEach(select => {
                const field = select.dataset.field;
                const index = parseInt(select.value);
                const isRequired = ['name', 'barcode', 'quantity', 'price'].includes(field);

                if (isRequired && index === -1) {
                    showNotification(`Fehler: Das Pflichtfeld **${select.previousElementSibling.textContent.replace('*', '').trim()}** wurde nicht zugeordnet.`, 'error', 5000);
                    hasError = true;
                }
                if (index !== -1) {
                    mappings[field] = index;
                }
            });

            if (hasError) return;
            
            let itemsImported = 0;
            const newInventoryItems = [];

            importedData.forEach(row => {
                const newItem = {};
                let isValid = true;

                // Daten extrahieren und parsen
                for (const [field, index] of Object.entries(mappings)) {
                    let value = row[index];
                    if (value === null || value === undefined) value = '';

                    switch (field) {
                        case 'quantity':
                        case 'minStock':
                            newItem[field] = parseInt(value) || 0;
                            break;
                        case 'price':
                        case 'duration':
                            // Ersetze Komma durch Punkt fÃ¼r das Parsen
                            const parsedValue = String(value).replace(',', '.');
                            newItem[field] = parseFloat(parsedValue) || 0;
                            break;
                        case 'name':
                        case 'barcode':
                            newItem[field] = String(value).trim();
                            if ((field === 'name' || field === 'barcode') && newItem[field] === '') {
                                isValid = false; // Pflichtfelder dÃ¼rfen nicht leer sein
                            }
                            break;
                        default:
                            newItem[field] = String(value).trim();
                            break;
                    }
                }
                
                if (isValid && newItem.barcode) {
                    // Standardwerte setzen, falls nicht zugeordnet
                    newItem.category = newItem.category || 'Sonstiges';
                    newItem.description = newItem.description || '';
                    newItem.image = newItem.image || ''; // Bild-URLs kÃ¶nnten auch importiert werden
                    
                    // PrÃ¼fen, ob Artikel bereits existiert (Update-Logik)
                    const existingIndex = inventory.findIndex(item => item.barcode === newItem.barcode);
                    if (existingIndex > -1) {
                        // Aktualisiere nur die Menge und die Details des bestehenden Artikels
                        inventory[existingIndex] = { ...inventory[existingIndex], ...newItem };
                    } else {
                        newInventoryItems.push(newItem);
                    }
                    itemsImported++;
                }
            });
            
            // Neue Artikel hinzufÃ¼gen
            inventory = [...inventory, ...newInventoryItems];
            
            showNotification(`${itemsImported} Artikel erfolgreich importiert/aktualisiert!`, 'success', 5000);
            
            importedData = null; // Daten lÃ¶schen
            document.getElementById('column-mapping').classList.add('hidden');
            document.getElementById('csv-file').value = '';
            
            saveInventoryLocal();
            saveInventoryToCloud();
            showTab('inventory');
        }

        /** Bricht den Import ab */
        function cancelImport() {
            importedData = null;
            document.getElementById('column-mapping').classList.add('hidden');
            document.getElementById('csv-file').value = '';
            showNotification('Import abgebrochen.', 'info');
        }

        /** LÃ¤dt Beispieldaten */
        function loadSampleData() {
            const sampleData = [
                { name: "Donnerhall Rakete", barcode: "400123456001", quantity: 20, price: 5.99, category: "Raketen", minStock: 10, duration: 15, effect: "Goldene Funken", description: "GroÃŸe Effektrakete mit lautem Knall und Goldweide." },
                { name: "Night Fury Batterie", barcode: "400123456002", quantity: 5, price: 29.50, category: "Batterien", minStock: 8, duration: 35, effect: "Bunte Sterne", description: "FÃ¤cherbatterie mit 50 Schuss in verschiedenen Farben." },
                { name: "Silber Cascade FontÃ¤ne", barcode: "400123456003", quantity: 15, price: 9.99, category: "FontÃ¤nen", minStock: 5, duration: 45, effect: "Silberne Kaskade", description: "Sehr helle und langanhaltende SilberfontÃ¤ne." },
                { name: "Green Flash Bengal", barcode: "400123456004", quantity: 3, price: 2.50, category: "Bengalos", minStock: 10, duration: 60, effect: "GrÃ¼ne Funken", description: "GrÃ¼nes Handbengalo, starke Rauchentwicklung." },
            ];
            
            // Artikel mit gleichem Barcode aktualisieren, ansonsten hinzufÃ¼gen
            sampleData.forEach(newItem => {
                const existingIndex = inventory.findIndex(item => item.barcode === newItem.barcode);
                if (existingIndex === -1) {
                    inventory.push(newItem);
                } else {
                    inventory[existingIndex] = { ...inventory[existingIndex], ...newItem };
                }
            });

            saveInventoryLocal();
            saveInventoryToCloud();
            showNotification(`${sampleData.length} Beispieldaten geladen/aktualisiert.`, 'success', 3000);
            showTab('inventory');
        }

        /** LÃ¤dt die Excel-Vorlage herunter (Template) */
        function downloadTemplate() {
            const header = ["Name", "Barcode", "Anzahl", "Preis", "Kategorie", "Mindestbestand", "Effektdauer (s)", "Effekttyp", "Beschreibung", "Bild-DataURL"];
            const rows = [
                ["Beispielrakete", "1234567890123", 10, 5.99, "Raketen", 5, 15, "Goldweide", "Effektbeschreibung hier...", "Optional: Bild-DataURL"]
            ];
            const data = [header, ...rows];
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Import-Vorlage");

            XLSX.writeFile(wb, `Pyrotechnik_Import_Vorlage.xlsx`);
        }

        // =======================================================
        // BERICHTE
        // =======================================================

        /** Aktualisiert die Statistik-Felder */
        function updateReports() {
            const totalItems = inventory.length;
            const totalValue = inventory.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            const lowStockItems = inventory.filter(item => item.quantity <= item.minStock);
            const lowStockCount = lowStockItems.length;
            
            const categories = new Set(inventory.map(item => item.category));
            const categoryCount = categories.size;

            const totalDuration = inventory.reduce((sum, item) => sum + (item.duration * item.quantity), 0);
            const totalQuantity = inventory.reduce((sum, item) => sum + item.quantity, 0);
            const avgDuration = totalQuantity > 0 ? (totalDuration / totalQuantity).toFixed(1) : 0;


            document.getElementById('total-items').textContent = totalItems;
            document.getElementById('total-value').textContent = `â‚¬${totalValue.toFixed(2)}`;
            document.getElementById('low-stock-count').textContent = lowStockCount;
            document.getElementById('category-count').textContent = categoryCount;
            document.getElementById('avg-duration').textContent = `${avgDuration}s`;
            
            // Niedrige BestÃ¤nde anzeigen
            const lowStockDiv = document.getElementById('low-stock-items');
            if (lowStockCount > 0) {
                lowStockDiv.innerHTML = lowStockItems.map(item => `
                    <div class="p-3 bg-red-100 rounded-lg flex justify-between items-center cursor-pointer" onclick="showTab('inventory'); document.getElementById('search-inventory').value='${item.barcode}'; renderInventory();">
                        <span class="font-medium text-red-800">${item.name}</span>
                        <span class="text-sm text-red-600">Nur ${item.quantity} (Min: ${item.minStock})</span>
                    </div>
                `).join('');
            } else {
                lowStockDiv.innerHTML = '<p class="text-gray-500 text-center py-4">Keine Artikel mit niedrigem Bestand</p>';
            }
        }


        // =======================================================
        // INITIALISIERUNG
        // =======================================================

        window.onload = function() {
            loadInventory();
            showTab('scanner');
        };
    </script>
</body>
</html>
